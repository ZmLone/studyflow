<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Master Your Prep</title>
    
    <!-- Performance Optimization: Preconnect & DNS Prefetch -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://www.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Defer non-critical scripts to unblock rendering -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

    <script>
window.showToast = function(message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = "fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-6 py-3 rounded-2xl font-bold text-sm shadow-2xl flex items-center gap-3 animate-in fade-in slide-in-from-bottom-4 duration-300";
    toast.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4 text-brand-500"></i> ${message}`;
    
    document.body.appendChild(toast);
    if(window.lucide) lucide.createIcons({ root: toast });

    // Remove after 4 seconds
    setTimeout(() => {
        toast.classList.add('animate-out', 'fade-out', 'slide-out-to-bottom-4');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
};
        tailwind.config = {
            darkMode: 'class', // Enable manual dark mode toggle
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e', 950: '#082f49' },
                        backlog: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c' },
                        // Custom dark mode palette adjustments
                        dark: {
                            bg: '#020617', // Slate 950
                            card: '#0f172a', // Slate 900
                            border: '#1e293b' // Slate 800
                        }
                    }
                }
            }
        }
    </script>
    <script>
        // Inline script to prevent FOUC (Flash of Unstyled Content) and default to DARK
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        /* Smooth Theme Transition */
        html { transition: background-color 0.3s, color 0.3s; }
        
        /* Optimization: Prevent FOUC (Flash of Unstyled Content) */
        body { visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in; }
        body.loaded { visibility: visible; opacity: 1; }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #334155; }
        
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        .dark .glass { background: rgba(15, 23, 42, 0.9); }
        
        .card-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Mobile Menu Transition */
        #mobile-menu-overlay { transition: opacity 0.3s ease; }
        #mobile-sidebar { transition: transform 0.3s ease; }
        .menu-open #mobile-menu-overlay { opacity: 1; pointer-events: auto; }
        .menu-open #mobile-sidebar { transform: translateX(0); }
        .menu-closed #mobile-menu-overlay { opacity: 0; pointer-events: none; }
        .menu-closed #mobile-sidebar { transform: translateX(-100%); }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0ea5e9; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 h-screen flex overflow-hidden selection:bg-brand-100 selection:text-brand-900 dark:selection:bg-brand-900 dark:selection:text-brand-100 menu-closed" id="app-body">

    <div id="global-error" class="hidden fixed inset-0 z-[100] bg-white flex items-center justify-center p-8">
        <div class="max-w-md text-center">
            <h2 class="text-xl font-bold text-red-600 mb-2">Something went wrong</h2>
            <p id="global-error-msg" class="text-sm text-slate-600 mb-4">Please refresh the page.</p>
            <button onclick="location.reload()" class="px-4 py-2 bg-slate-100 rounded-lg text-sm font-bold">Reload</button>
        </div>
    </div>
    <script>
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
            const el = document.getElementById('global-error');
            const txt = document.getElementById('global-error-msg');
            if(el && txt) {
                el.classList.remove('hidden');
                txt.textContent = `${msg}`;
            }
        };
    </script>

    

<div id="auth-modal" class="fixed inset-0 z-[60] bg-slate-500/30 dark:bg-black/40 backdrop-blur-xl flex items-center justify-center hidden transition-opacity duration-300">
        
        <div class="bg-white/80 dark:bg-[#1c1c1e]/90 backdrop-blur-2xl rounded-3xl shadow-2xl p-8 w-full max-w-[400px] mx-4 relative border border-white/20 dark:border-white/5 ring-1 ring-black/5">
            
            <div class="mb-8 text-center flex flex-col items-center">
                <div class="w-16 h-16 bg-gradient-to-br from-brand-500 to-brand-600 rounded-2xl shadow-lg shadow-brand-500/30 flex items-center justify-center text-white mb-6">
                    <i data-lucide="layers" class="w-8 h-8"></i>
                </div>
                <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Welcome Back</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-2 font-medium">Sign in to sync your progress</p>
            </div>

            <form id="auth-form" class="space-y-4">
                <div class="space-y-4">
                    <div class="relative group">
                        <input type="email" id="auth-email" required 
                            class="w-full bg-slate-100 dark:bg-[#2c2c2e] border-0 rounded-xl px-4 py-4 text-[15px] font-medium text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-brand-500/50 transition-all outline-none" 
                            placeholder="Email address">
                    </div>
                    
                    <div class="relative group">
                        <input type="password" id="auth-pass" required 
                            class="w-full bg-slate-100 dark:bg-[#2c2c2e] border-0 rounded-xl px-4 py-4 text-[15px] font-medium text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-brand-500/50 transition-all outline-none" 
                            placeholder="Password">
                    </div>
                </div>
                
                <div id="auth-error" class="hidden text-red-500 text-xs font-semibold bg-red-50 dark:bg-red-500/10 p-3 rounded-xl flex items-center gap-2 animate-in slide-in-from-top-1">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span id="auth-error-msg">Error message</span>
                </div>

                <div class="pt-2">
                    <button type="button" onclick="handleAuth('login')" 
                        class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-black font-bold rounded-full text-[15px] hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-slate-500/20 dark:shadow-none transition-all duration-200 flex justify-center items-center gap-2">
                        <span id="auth-btn-text">Sign In</span>
                        <div id="auth-loader" class="loader hidden border-white/30 border-t-white dark:border-black/30 dark:border-t-black"></div>
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-3 pt-1 text-center">
                    <button type="button" onclick="handleAuth('signup')" class="text-brand-600 dark:text-brand-400 text-sm font-semibold hover:opacity-80 transition-opacity">
                        Create new account
                    </button>
                </div>
            </form>
            
            <div class="my-6 border-t border-slate-200 dark:border-white/10"></div>
            
            <div class="text-center">
                <button onclick="startDemoMode()" class="text-xs font-medium text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    Use offline mode (Local only)
                </button>
            </div>
        </div>
    </div>


    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 md:hidden" onclick="toggleMobileMenu()"></div>
    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 z-50 flex flex-col shadow-2xl md:hidden transform -translate-x-full">
        <div class="p-6 pb-2">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3 text-brand-600 dark:text-brand-500">
                    <div class="p-2 bg-brand-50 dark:bg-brand-900/30 rounded-xl">
                        <i data-lucide="layers" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900 dark:text-white">StudyFlow</span>
                </div>
                <button onclick="toggleMobileMenu()" class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" aria-label="Close menu">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            



<button onclick="switchView('overview')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="overview">
    <i data-lucide="layout-grid" class="w-5 h-5"></i>
    Overview
</button>

<button onclick="switchView('target')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="target">
    <i data-lucide="crosshair" class="w-5 h-5 text-blue-500 fill-blue-500/20"></i>
    Next Target
</button>

<button onclick="switchView('backlog')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="backlog">
    <i data-lucide="history" class="w-5 h-5 text-orange-500 fill-orange-500/20"></i>
    Backlog Plan
</button>

<button onclick="switchView('mistakes')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="mistakes">
    <i data-lucide="book" class="w-5 h-5 text-rose-500 fill-rose-500/20"></i>
    Mistake Notebook
</button>

<button onclick="switchView('leaderboard')" id="nav-leaderboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="leaderboard">
    <i data-lucide="medal" class="w-5 h-5 text-amber-500 fill-amber-500/20"></i>
    Leaderboard
</button>    
<button onclick="switchView('namaz')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-white/5" data-view="namaz">
    <i data-lucide="book-heart" class="w-5 h-5 text-emerald-500 fill-emerald-500/20"></i>
    Spiritual Insights
</button>

        </div>
<div class="mt-auto p-6 border-t border-slate-100 dark:border-slate-800 space-y-3 bg-white dark:bg-slate-900">

    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 mb-2">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-bold text-slate-400 uppercase">Daily Goal</span>
            <span class="text-xs font-bold text-brand-600 dark:text-brand-400" id="mobile-sidebar-progress-text">0%</span>
        </div>
        <div class="h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
            <div id="mobile-sidebar-progress-bar" class="h-full w-0 transition-all duration-500 bg-brand-500"></div>
        </div>
    </div>
    <button onclick="openProfileModal(); toggleMobileMenu();" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all group">
           
        <i data-lucide="user-circle" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
        Profile Settings
    </button>

    <div id="mobile-user-card" onclick="handleProfileClick()" class="flex items-center gap-3 px-3 py-3 rounded-2xl border border-transparent transition-all cursor-pointer">
        <div id="mobile-user-avatar-bg" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm transition-colors">
            <span id="mobile-user-avatar-text">?</span>
        </div>

        <div class="flex-1 min-w-0">
            <p class="text-sm font-bold truncate transition-colors" id="mobile-user-name">Guest</p>
            <div class="flex items-center gap-1.5">
                <div id="mobile-status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                <p class="text-[10px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400" id="mobile-sync-status">Local Only</p>
            </div>
        </div>

        <button id="mobile-auth-btn" onclick="handleAuthAction(event)" class="p-2 rounded-xl transition-all">
            <i data-lucide="log-in" class="w-5 h-5"></i>
        </button>
    </div>
</div>        </div>  </div>
    </div>

  <nav class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex-col flex-shrink-0 hidden md:flex z-20 transition-colors duration-300">
        <div class="p-6 pb-2">
            <div class="flex items-center gap-3 text-brand-600 dark:text-brand-400 mb-8">
                <div class="p-2 bg-brand-50 dark:bg-slate-800 rounded-xl">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-900 dark:text-white">StudyFlow</span>
            </div>

            <div class="space-y-1">
                <button onclick="switchView('overview')" id="nav-overview" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-sm transition-all bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    Overview
                </button>
                
                <button onclick="switchView('target')" id="nav-target" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all">
                    <i data-lucide="crosshair" class="w-5 h-5 text-blue-500 fill-blue-500/20"></i>
                    Next Target
                </button>
                
                <button onclick="switchView('backlog')" id="nav-backlog" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all">
                    <i data-lucide="history" class="w-5 h-5 text-orange-500 fill-orange-500/20"></i>
                    Backlog Plan
                </button>
                
                <button onclick="switchView('mistakes')" id="nav-mistakes" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all">
                    <i data-lucide="book" class="w-5 h-5 text-rose-500 fill-rose-500/20"></i>
                    Mistake Notebook
                </button>

                <button onclick="switchView('leaderboard')" id="nav-leaderboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all">
                    <i data-lucide="medal" class="w-5 h-5 text-amber-500 fill-amber-500/20"></i>
                    Leaderboard
                </button>
<button onclick="switchView('namaz')" id="nav-namaz" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all">
    <i data-lucide="book-heart" class="w-5 h-5 text-emerald-500 fill-emerald-500/20"></i>
    Spiritual Insights
</button>
            </div>
        </div>
<div class="mt-auto p-6 border-t border-slate-100 dark:border-slate-800 space-y-3">
    
    <button onclick="openProfileModal()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all group">
        <i data-lucide="user-circle" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
        Profile Settings
    </button>

    <button onclick="toggleTheme()" class="w-full flex items-center justify-between p-2 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors" aria-label="Toggle dark mode">
        <div class="flex items-center gap-2 text-xs font-bold">
            <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
            <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
            <span id="theme-text">Dark Mode</span>
        </div>
        <div class="w-8 h-4 bg-slate-200 dark:bg-slate-700 rounded-full relative">
            <div class="w-2 h-2 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 dark:translate-x-4"></div>
        </div>
    </button>

   <div id="desktop-user-card" onclick="handleProfileClick()" class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800 p-2 rounded-2xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-brand-300 dark:hover:border-slate-500 transition-all group">
        
        <div id="desktop-user-avatar-bg" class="w-9 h-9 rounded-xl flex items-center justify-center text-xs font-bold shadow-sm transition-colors">
            <span id="desktop-user-avatar-text">?</span>
        </div>
        
        <div class="flex-1 min-w-0">
            <p class="text-xs font-bold text-slate-800 dark:text-slate-200 truncate" id="desktop-user-name">Guest</p>
            <p class="text-[9px] font-bold flex items-center gap-1" id="desktop-sync-status">
                <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span> Not Synced
            </p>
        </div>
        
        <button id="desktop-auth-btn" onclick="handleAuthAction(event)" class="text-slate-400 hover:text-brand-600 dark:hover:text-white p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-700 transition-all" title="Log In / Out">
            <i data-lucide="log-in" class="w-4 h-4"></i>
        </button>
    </div>
    <div class="bg-slate-50 dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-bold text-slate-400 uppercase" id="footer-goal-label">Daily Goal</span>
            <span class="text-xs font-bold text-brand-600 dark:text-brand-400" id="sidebar-progress-text">0%</span>
        </div>
        <div class="h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
            <div id="sidebar-progress-bar" class="h-full w-0 transition-all duration-500"></div>
        </div>
    </div>
</div>
            </nav>  

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
        
        <div class="md:hidden h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 shrink-0">
            <span class="font-bold text-lg text-slate-800 dark:text-white">StudyFlow</span>
            <button onclick="toggleMobileMenu()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg active:bg-slate-200 transition-colors text-slate-600 dark:text-slate-300" aria-label="Toggle menu">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
        </div>

 <div id="view-overview" class="flex-1 flex flex-col overflow-hidden relative bg-slate-50 dark:bg-black transition-colors">
            
<header class="px-4 py-4 md:px-6 md:py-5 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex justify-between items-center shrink-0 z-20 sticky top-0">
    <div>
        <h1 class="text-lg md:text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <i data-lucide="layout-dashboard" class="w-5 h-5 text-brand-500"></i> Dashboard
        </h1>
        <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5 hidden xs:block" id="overview-date">...</p>
    </div>
    
    <div class="flex items-center gap-2">
        <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-full border border-slate-200 dark:border-slate-700">
            <button onclick="changeDay(-1)" class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded-full transition-all text-slate-600 dark:text-slate-300" aria-label="Previous day"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
            <button onclick="goToToday()" class="px-3 h-7 md:h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded-full transition-all text-xs font-bold text-slate-700 dark:text-slate-200">Today</button>
            <button onclick="changeDay(1)" class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded-full transition-all text-slate-600 dark:text-slate-300" aria-label="Next day"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
        </div>

        <button onclick="openPrayerModal()" class="ml-1 md:ml-4 flex items-center gap-2 px-2 py-1.5 md:px-3 md:py-1.5 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 rounded-full font-bold text-xs hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-all border border-emerald-200 dark:border-emerald-800/50">
            <i data-lucide="moon-star" class="w-3.5 h-3.5"></i>
            <span class="hidden md:inline">Prayers</span>
            <span id="header-prayer-count" class="bg-emerald-600 text-white text-[9px] px-1.5 py-0.5 rounded ml-0 md:ml-1">0/5</span>
        </button>
    </div>
</header>

            <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 relative z-10">
                <div class="max-w-5xl mx-auto space-y-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <div class="md:col-span-2 bg-gradient-to-br from-brand-600 to-blue-700 dark:from-blue-900 dark:to-slate-900 rounded-3xl p-6 text-white shadow-xl shadow-brand-500/10 relative overflow-hidden group transition-all hover:scale-[1.01]">
                            <div class="absolute -right-10 -top-10 text-white/10 group-hover:text-white/20 transition-colors rotate-12">
                                <i data-lucide="target" class="w-48 h-48"></i>
                            </div>
                            
                            <div class="relative z-10 flex flex-col h-full justify-between">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/20 text-[10px] font-bold uppercase tracking-wider mb-3">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                                            Primary Goal
                                        </div>
                                        <h3 class="text-3xl font-black tracking-tight" id="card-main-name">...</h3>
                                        <p class="text-sm text-brand-100 font-medium opacity-90" id="card-main-date-info">...</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-5xl font-black tracking-tighter" id="card-main-days">--</span>
                                        <span class="text-xs font-bold uppercase tracking-widest text-brand-200">Days Left</span>
                                    </div>
                                </div>

                                <div class="mt-8">
                                    <div class="flex justify-between text-xs font-bold text-brand-100 mb-2 uppercase tracking-wider">
                                        <span>Syllabus Covered</span>
                                        <span id="card-main-text">0%</span>
                                    </div>
                                    <div class="h-3 w-full bg-black/20 rounded-full overflow-hidden backdrop-blur-sm border border-white/10">
                                        <div class="h-full bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)] w-0 transition-all duration-1000 ease-out" id="card-main-bar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-3xl p-6 border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden flex flex-col justify-between group transition-all hover:border-orange-200 dark:hover:border-orange-900">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-orange-500 font-bold text-[10px] uppercase tracking-wider mb-1">Critical Focus</p>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">Backlog Plan</h3>
                                </div>
                                <div class="p-2 bg-orange-50 dark:bg-orange-900/20 rounded-xl text-orange-500">
                                    <i data-lucide="history" class="w-5 h-5"></i>
                                </div>
                            </div>
                            
                            <div class="text-center py-2">
                                <span class="text-4xl font-black text-slate-800 dark:text-white" id="backlog-days-large">--</span>
                                <p class="text-xs text-slate-400 font-bold uppercase mt-1">Days to Catch Up</p>
                            </div>

                            <div class="mt-4">
                                <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1.5 uppercase">
                                    <span>Recovery</span>
                                    <span id="card-backlog-text">0%</span>
                                </div>
                                <div class="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-orange-500 to-amber-500 w-0 transition-all duration-1000" id="card-backlog-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-end justify-between mb-4 px-1">
                            <div>
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Today's Mission</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium" id="agenda-date-display">...</p>
                            </div>
                            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-green-50 dark:bg-green-900/20 rounded-full border border-green-100 dark:border-green-900/50">
                                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <span class="text-xs font-bold text-green-700 dark:text-green-300">Live Tracker</span>
                            </div>
                        </div>
<div class="flex items-end justify-between mb-4 px-1">
        </div>

    <div id="ai-strategy-container" class="mb-6 hidden animate-in slide-in-from-top-4 duration-500"></div>
    <div id="overview-task-list" class="space-y-3 pb-32 min-h-[200px]">
    </div>
                        <div id="overview-task-list" class="space-y-3 pb-32 min-h-[200px]">
                            </div>
                    </div>

                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-black dark:via-black dark:to-transparent z-30">
                <div class="max-w-3xl mx-auto">
                    <form id="add-task-form" class="flex gap-2 items-center bg-white dark:bg-slate-900 p-2 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 ring-4 ring-slate-100 dark:ring-slate-800 transition-all focus-within:ring-brand-100 dark:focus-within:ring-brand-900/30 transform focus-within:-translate-y-1">
                        
                        <div class="pl-3 text-slate-400">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        </div>

                        <input type="text" id="new-task-input" placeholder="Add a new task..." 
                            class="flex-1 bg-transparent border-none text-sm font-medium text-slate-800 dark:text-white placeholder:text-slate-400 focus:ring-0 px-2 py-3 outline-none">
                        
                        <div class="flex gap-2 pr-1">
                            <select id="new-task-type" class="bg-slate-50 dark:bg-slate-800 border-none text-[10px] font-bold text-slate-600 dark:text-slate-300 rounded-lg px-2 py-2 outline-none cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors uppercase tracking-wider">
                                <option value="main">Exam</option>
                                <option value="backlog">Backlog</option>
                            </select>

                            <select id="new-task-subject" class="bg-slate-50 dark:bg-slate-800 border-none text-[10px] font-bold text-slate-600 dark:text-slate-300 rounded-lg px-2 py-2 outline-none cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors uppercase tracking-wider" onchange="updateFooterProgress()">
                                <option value="General">General</option>
                                <option value="Physics">Phy</option>
                                <option value="Chemistry">Chem</option>
                                <option value="Botany">Bot</option>
                                <option value="Zoology">Zoo</option>
                            </select>

                            <button type="submit" class="bg-brand-600 hover:bg-brand-700 text-white p-2.5 rounded-xl font-bold transition-all shadow-lg shadow-brand-500/30" aria-label="Add">
                                <i data-lucide="arrow-up" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>       


        <div id="view-target" class="hidden flex-1 flex flex-col overflow-hidden bg-white dark:bg-slate-900 transition-colors">
            <header class="px-8 py-6 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row md:justify-between md:items-center gap-4 bg-slate-50/50 dark:bg-slate-900/50">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-brand-100 dark:bg-brand-900 text-brand-700 dark:text-brand-300 tracking-wide">Main Track</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white" id="syllabus-title">Syllabus</h2>
                </div>
                
                <div class="flex-1 max-w-md w-full relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                    </div>
                    <input type="text" 
                        onkeyup="handleSearch(this.value, 'main')" 
                        placeholder="Search topics (e.g., 'Thermodynamics')..." 
                        class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm text-slate-800 dark:text-white rounded-xl py-2.5 pl-10 pr-4 outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all shadow-sm"
                    >
                </div>

                <div class="text-right hidden md:block">
                    <div class="text-sm font-medium text-slate-500 dark:text-slate-400">Exam Date</div>
                    <div class="text-lg font-bold text-slate-900 dark:text-white" id="syllabus-date">...</div>
                    <div class="text-xs font-bold text-brand-600 dark:text-brand-400 mt-1" id="syllabus-days-left">...</div>
                </div>
            </header>
            <div id="main-syllabus-container" class="flex-1 overflow-y-auto p-8 custom-scroll space-y-4">
                </div>
        </div>

        <div id="view-backlog" class="hidden flex-1 flex flex-col overflow-hidden bg-white dark:bg-slate-900 transition-colors">
            <header class="px-8 py-6 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row md:justify-between md:items-center gap-4 bg-orange-50/30 dark:bg-orange-900/10">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 tracking-wide">Recovery Plan</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Backlog: AIATS-5</h2>
                </div>

                <div class="flex-1 max-w-md w-full relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-400 group-focus-within:text-orange-500 transition-colors"></i>
                    </div>
                    <input type="text" 
                        onkeyup="handleSearch(this.value, 'backlog')" 
                        placeholder="Search backlog..." 
                        class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm text-slate-800 dark:text-white rounded-xl py-2.5 pl-10 pr-4 outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all shadow-sm"
                    >
                </div>

                <div class="text-right hidden md:block">
                    <div class="text-sm font-medium text-slate-500 dark:text-slate-400">Deadline</div>
                    <div class="text-lg font-bold text-slate-900 dark:text-white">Feb 1, 2026</div>
                    <div class="text-xs font-bold text-orange-600 dark:text-orange-400 mt-1" id="backlog-days-left">...</div>
                </div>
            </header>
            <div id="backlog-syllabus-container" class="flex-1 overflow-y-auto p-8 custom-scroll space-y-4">
                </div>
        </div>

        <div id="view-mistakes" class="hidden flex-1 flex flex-col overflow-hidden bg-slate-50 dark:bg-slate-950 transition-colors relative">
    
            <!-- SECTION A: THE BOOKSHELF (Visible initially) -->
            <div id="notebook-shelf" class="flex-1 p-8 overflow-y-auto custom-scroll flex flex-col items-center justify-center">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Mistake Notebooks</h2>
                    <p class="text-slate-500 dark:text-slate-400">Select a subject to open its error log.</p>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl w-full">
                    <!-- Physics Book -->
                    <div onclick="openNotebook('Physics')" class="group relative cursor-pointer transform transition-all hover:-translate-y-2 duration-300">
                        <div class="absolute inset-0 bg-blue-600 rounded-r-2xl rounded-l-sm blur-lg opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative bg-gradient-to-br from-blue-600 to-blue-800 h-64 rounded-r-2xl rounded-l-md shadow-xl flex flex-col items-center justify-center border-l-8 border-blue-900 overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-full bg-white/5 skew-x-12 transform origin-bottom"></div>
                            <i data-lucide="atom" class="w-16 h-16 text-white/80 mb-4"></i>
                            <h3 class="text-2xl font-bold text-white tracking-wider">PHYSICS</h3>
                            <div class="mt-4 px-3 py-1 bg-white/20 backdrop-blur-md rounded-full text-xs font-bold text-white border border-white/30" id="count-physics">0 Errors</div>
                        </div>
                    </div>
        
                    <!-- Chemistry Book -->
                    <div onclick="openNotebook('Chemistry')" class="group relative cursor-pointer transform transition-all hover:-translate-y-2 duration-300">
                        <div class="absolute inset-0 bg-amber-500 rounded-r-2xl rounded-l-sm blur-lg opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative bg-gradient-to-br from-amber-500 to-orange-700 h-64 rounded-r-2xl rounded-l-md shadow-xl flex flex-col items-center justify-center border-l-8 border-orange-900 overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-full bg-white/5 skew-x-12 transform origin-bottom"></div>
                            <i data-lucide="flask-conical" class="w-16 h-16 text-white/80 mb-4"></i>
                            <h3 class="text-2xl font-bold text-white tracking-wider">CHEMISTRY</h3>
                            <div class="mt-4 px-3 py-1 bg-white/20 backdrop-blur-md rounded-full text-xs font-bold text-white border border-white/30" id="count-chemistry">0 Errors</div>
                        </div>
                    </div>
        
                    <!-- Biology Book -->
                    <div onclick="openNotebook('Biology')" class="group relative cursor-pointer transform transition-all hover:-translate-y-2 duration-300">
                        <div class="absolute inset-0 bg-emerald-600 rounded-r-2xl rounded-l-sm blur-lg opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative bg-gradient-to-br from-emerald-600 to-green-800 h-64 rounded-r-2xl rounded-l-md shadow-xl flex flex-col items-center justify-center border-l-8 border-green-900 overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-full bg-white/5 skew-x-12 transform origin-bottom"></div>
                            <i data-lucide="dna" class="w-16 h-16 text-white/80 mb-4"></i>
                            <h3 class="text-2xl font-bold text-white tracking-wider">BIOLOGY</h3>
                            <div class="mt-4 px-3 py-1 bg-white/20 backdrop-blur-md rounded-full text-xs font-bold text-white border border-white/30" id="count-biology">0 Errors</div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- SECTION B: THE OPEN NOTEBOOK (Hidden initially) -->
            <div id="notebook-content" class="hidden flex-1 flex flex-col h-full bg-white dark:bg-slate-900">
                <!-- Notebook Header -->
                <div id="notebook-header-bg" class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between transition-colors bg-slate-50 dark:bg-slate-800/50">
                    <div class="flex items-center gap-4">
                        <button onclick="closeNotebook()" class="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500 dark:text-slate-400">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white" id="notebook-title">Subject Notebook</h2>
                            <p class="text-xs font-medium text-slate-500" id="notebook-subtitle">Error Log</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('add-mistake-modal').classList.remove('hidden')" class="flex items-center gap-2 px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg text-sm font-bold shadow-lg hover:opacity-90 transition-opacity">
                        <i data-lucide="plus" class="w-4 h-4"></i> Log Mistake
                    </button>
                </div>
        
                <!-- Notebook Pages (List) -->
                <div id="notebook-entries" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50 dark:bg-slate-950 custom-scroll">
                    <!-- Entries injected here -->
                </div>
            </div>
        
            <!-- ADD MISTAKE MODAL (Overlay) -->
            <div id="add-mistake-modal" class="hidden absolute inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-lg shadow-2xl border border-slate-200 dark:border-slate-800 flex flex-col max-h-[90vh]">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                        <h3 class="font-bold text-lg dark:text-white">Log New Error</h3>
                        <button onclick="document.getElementById('add-mistake-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto custom-scroll space-y-4">
                        <form id="mistake-form" class="space-y-4">
                            <!-- Hidden input to store image base64 -->
                            <input type="hidden" id="mistake-image-base64">
        
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Subject</label>
                                <input type="text" id="mistake-subject-display" disabled class="w-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-xl px-4 py-2 text-sm font-bold border border-transparent">
                            </div>
        
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                                    <select id="mistake-type" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 text-sm dark:text-white outline-none focus:border-brand-500">
                                        <option value="Conceptual">Conceptual</option>
                                        <option value="Silly">Silly/Calculation</option>
                                        <option value="Memory">Fact/Formula</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Chapter</label>
                                    <input type="text" id="mistake-chapter" placeholder="e.g. Thermodynamics" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 text-sm dark:text-white outline-none focus:border-brand-500">
                                </div>
                            </div>
        
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Question / Mistake Description</label>
                                <textarea id="mistake-desc" rows="3" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white outline-none focus:border-brand-500 resize-none" placeholder="What went wrong?"></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Correct Answer / Explanation</label>
                                <textarea id="mistake-answer" rows="3" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm dark:text-white outline-none focus:border-brand-500 resize-none" placeholder="What is the correct solution?"></textarea>
                            </div>
        
                            <!-- Image Upload Section -->
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Attach Image (Optional)</label>
                                <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-4 text-center hover:border-brand-500 transition-colors cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="mistake-file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleImageUpload(this)">
                                    <div id="upload-placeholder" class="flex flex-col items-center gap-2 text-slate-400">
                                        <i data-lucide="image-plus" class="w-6 h-6"></i>
                                        <span class="text-xs">Click to upload screenshot (Max 800KB)</span>
                                    </div>
                                    <div id="image-preview-container" class="hidden relative">
                                        <img id="image-preview" src="" class="max-h-32 mx-auto rounded-lg shadow-sm">
                                        <button type="button" onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-md"><i data-lucide="x" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                            </div>
        
                            <button type="submit" class="w-full py-3 bg-brand-600 text-white font-bold rounded-xl shadow-lg hover:bg-brand-700 transition-all">Save to Notebook</button>
                        </form>
                    </div>
                </div>
            </div>
        
            <!-- IMAGE VIEWER MODAL (To see large images) -->
            <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
                <img id="full-size-image" src="" class="max-w-full max-h-full rounded-lg shadow-2xl">
            </div>
        </div>
<div id="view-namaz" class="hidden flex-1 flex flex-col overflow-hidden bg-slate-50 dark:bg-slate-950 transition-colors">
    <header class="px-8 py-6 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
            <i data-lucide="moon-star" class="w-6 h-6 text-emerald-500"></i> Spiritual Growth
        </h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Your journey towards consistency.</p>
    </header>

    <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
        <div class="max-w-4xl mx-auto space-y-6">
            
            <div class="bg-gradient-to-r from-emerald-800 to-teal-900 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-10 opacity-10">
                    <i data-lucide="lamp-ceiling" class="w-64 h-64"></i>
                </div>
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-700/50 border border-emerald-600/50 text-emerald-100 text-[10px] font-bold uppercase tracking-wider mb-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span> Upcoming
                        </div>
                        <h2 class="text-3xl font-bold">Ramadan 2026</h2>
                        <p class="text-emerald-100/80 mt-1 max-w-md">"O you who have believed, decreed upon you is fasting... that you may become righteous."</p>
                    </div>
                    <div class="text-center bg-black/20 backdrop-blur-sm p-4 rounded-2xl border border-white/10 min-w-[120px]">
                        <span class="block text-4xl font-black tracking-tight" id="ramadan-days-left">--</span>
                        <span class="text-[10px] uppercase font-bold text-emerald-200 tracking-widest">Days Left</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="p-4 bg-green-100 dark:bg-green-900/20 rounded-full text-green-600 dark:text-green-400">
                        <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Strongest Habit</p>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="insight-best">Analyzing...</h3>
                        <p class="text-xs text-slate-500">Most consistent prayer this month.</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="p-4 bg-orange-100 dark:bg-orange-900/20 rounded-full text-orange-600 dark:text-orange-400">
                        <i data-lucide="alert-circle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Needs Focus</p>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white" id="insight-worst">Analyzing...</h3>
                        <p class="text-xs text-slate-500">Often missed. You can fix this!</p>
                    </div>
                </div>
            </div>

            <div class="bg-amber-50 dark:bg-amber-900/10 rounded-3xl p-8 border border-amber-100 dark:border-amber-900/30 relative text-center">
                <i data-lucide="quote" class="w-8 h-8 text-amber-300 dark:text-amber-800/50 absolute top-6 left-6"></i>
                <h3 class="text-sm font-bold text-amber-600 dark:text-amber-500 uppercase tracking-widest mb-4">Daily Motivation</h3>
                <p class="text-lg md:text-xl font-medium text-slate-800 dark:text-slate-200 font-serif leading-relaxed italic" id="daily-hadith-text">
                    "Loading Hadith..."
                </p>
                <div class="mt-4 inline-block px-3 py-1 bg-amber-100 dark:bg-amber-900/40 rounded-lg text-xs font-bold text-amber-700 dark:text-amber-400" id="daily-hadith-source">
                    Sahih Bukhari
                </div>
            </div>

        </div>
    </div>
</div>
<div id="view-leaderboard" class="hidden flex-1 flex flex-col overflow-hidden bg-slate-50 dark:bg-slate-950 transition-colors">
    <header class="px-8 py-6 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                <i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i> Leaderboard
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Compete with other aspirants.</p>
        </div>
        
        <div class="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
            <button onclick="switchRankTab('overall')" id="tab-overall" class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-slate-800 dark:text-white">Overall</button>
            <button onclick="switchRankTab('exam')" id="tab-exam" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">Exam %</button>
            <button onclick="switchRankTab('backlog')" id="tab-backlog" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">Backlog %</button>
            <button onclick="switchRankTab('tests')" id="tab-tests" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">Tests</button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 dark:from-indigo-900 dark:to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 flex items-center justify-between">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Your Performance</p>
                    <h3 class="text-2xl font-bold" id="lb-user-name">Guest User</h3>
                    <div class="flex gap-4 mt-2 text-sm font-medium text-slate-300">
                        <span>Exam: <span id="lb-my-exam" class="text-white">0%</span></span>
                        <span>Backlog: <span id="lb-my-backlog" class="text-white">0%</span></span>
                        <span>Tests: <span id="lb-my-tests" class="text-white">0</span></span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-3xl font-black text-yellow-400" id="lb-my-rank">#--</p>
                    <p class="text-xs font-bold text-slate-400 uppercase">Current Rank</p>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                <div class="grid grid-cols-12 gap-4 p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 text-xs font-bold text-slate-500 uppercase tracking-wider">
                    <div class="col-span-2 text-center">Rank</div>
                    <div class="col-span-6">Student</div>
                    <div class="col-span-4 text-right" id="lb-header-score">Score</div>
                </div>
                <div id="leaderboard-list" class="divide-y divide-slate-100 dark:divide-slate-800">
                    <div class="p-8 text-center text-slate-400">Loading rankings...</div>
                </div>
            </div>
        </div>
    </div>
</div>
    </main>
<div id="profile-modal" class="hidden fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-200 dark:border-slate-800 p-6 animate-in fade-in zoom-in duration-200">
        <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Edit Profile</h3>
        <p class="text-sm text-slate-500 mb-6">What should we call you?</p>
        
        <form onsubmit="event.preventDefault(); saveProfileName();">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Display Name</label>
            <input type="text" id="profile-name-input" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm dark:text-white focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all placeholder:text-slate-400" placeholder="e.g. Dr. Future">
            
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="document.getElementById('profile-modal').classList.add('hidden')" class="flex-1 py-3 px-4 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">Cancel</button>
                <button type="submit" class="flex-1 py-3 px-4 bg-brand-600 text-white font-bold rounded-xl text-sm hover:bg-brand-700 shadow-lg shadow-brand-200 dark:shadow-none transition-all">Save Name</button>
            </div>
        </form>
    </div>
</div>
<div id="prayer-modal" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity animate-in fade-in duration-200">
    <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm shadow-2xl border border-slate-200 dark:border-slate-800 p-6 relative">
        <button onclick="document.getElementById('prayer-modal').classList.add('hidden')" class="absolute top-4 right-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-red-500 transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
        <div class="text-center mb-6 mt-2">
            <div class="w-14 h-14 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-2xl flex items-center justify-center mx-auto mb-3">
                <i data-lucide="moon" class="w-7 h-7"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Daily Prayers</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 font-medium" id="modal-prayer-date">...</p>
        </div>
        <div class="grid grid-cols-1 gap-2" id="modal-prayer-list"></div>
    </div>
</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
 import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";       

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDcQsD4kPTl4KpU4wphfkNjizPsUMQO64M",
            authDomain: "mystudyplan-74b62.firebaseapp.com",
            projectId: "mystudyplan-74b62",
            storageBucket: "mystudyplan-74b62.firebasestorage.app",
            messagingSenderId: "196958661158",
            appId: "1:196958661158:web:e553fa59e4f21f205e14e7"
        };
        // ----------------------------------------

        let app, auth, db;
        let isFirebaseActive = false;
        let currentUser = null;
        let unsubscribeDoc = null;
        
        // Use global app_id variable if available
        const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Premium Sound with Error Handling
        const successSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3');
        successSound.volume = 0.5;

        // Determine Environment
        const isCanvasEnv = typeof __firebase_config !== 'undefined';
        const hasUserConfig = YOUR_FIREBASE_CONFIG.apiKey !== "";

        if (isCanvasEnv) {
            const canvasConfig = JSON.parse(__firebase_config);
            app = initializeApp(canvasConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseActive = true;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token);
            } else {
                signInAnonymously(auth);
            }
        } else if (hasUserConfig) {
            app = initializeApp(YOUR_FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            isFirebaseActive = true;
        }
        
        // Helper to safely get document reference based on environment rules
        function getSafeDocRef(uid) {
            const collectionName = "studyData";
            const docName = "main";
            
            if (isCanvasEnv) {
                // Rule: artifacts/{appId}/users/{userId}/{collectionName}
                return doc(db, 'artifacts', globalAppId, 'users', uid, collectionName, docName);
            } else {
                // Default fallback for external hosting
                return doc(db, 'users', uid, collectionName, docName);
            }
        }

        // --- AUTH FUNCTIONS ---
        window.handleAuth = async (mode) => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errEl = document.getElementById('auth-error');
            const errMsg = document.getElementById('auth-error-msg');
            const loader = document.getElementById('auth-loader');
            const btnText = document.getElementById('auth-btn-text');

            if(!email || !pass) {
                errMsg.textContent = "Please fill in all fields.";
                errEl.classList.remove('hidden');
                return;
            }

            loader.classList.remove('hidden');
            btnText.textContent = "Processing...";
            errEl.classList.add('hidden');

            try {
                if(mode === 'login') {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    await createUserWithEmailAndPassword(auth, email, pass);
                }
                document.getElementById('auth-modal').classList.add('hidden');
            } catch (error) {
                errMsg.textContent = error.message.replace('Firebase: ', '');
                errEl.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                btnText.textContent = mode === 'login' ? "Log In" : "Create Account";
            }
        };

        // FIXED: Added unsubscribeDoc() call to prevent memory leak
        window.handleLogout = async () => {
            if(isFirebaseActive) {
                if (unsubscribeDoc) {
                    unsubscribeDoc();
                    unsubscribeDoc = null;
                }
                await signOut(auth);
                state.tasks = {};
                state.dailyTestsAttempted = {};
                state.mistakes = []; // Reset mistakes on logout
                state.expandedFocusGroups = {};
                state.expandedTests = {};
                renderAll();
                document.getElementById('auth-modal').classList.remove('hidden');
            } else {
                if(confirm("Exit Demo Mode? This will revert to the login screen.")) {
                    localStorage.removeItem('studyflow_demo_mode');
                    location.reload();
                }
            }
        };

        window.startDemoMode = () => {
            localStorage.setItem('studyflow_demo_mode', 'true');
            document.getElementById('auth-modal').classList.add('hidden');
            initLocalMode();
        };

        // --- DARK MODE LOGIC ---
        window.toggleTheme = function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-text').textContent = 'Light Mode';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-text').textContent = 'Dark Mode';
            }
        };

        // Initialize Theme (Default to Dark)
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
            document.getElementById('theme-text').textContent = 'Light Mode';
        } else {
            // Default path
            document.documentElement.classList.add('dark');
            document.getElementById('theme-text').textContent = 'Dark Mode';
        }

        // --- DATA ---
 const mainSchedule = [
             {
                name: "AIATS-4",
                date: new Date('2026-01-18T00:00:00'),
                syllabus: [
                    { 
                        subject: "Physics", 
                        topic: "Thermal Properties", 
                        dailyTests: [
                            {name:"DT-38 (XI)", subs:["Temp Scales", "Ideal Gas Eq", "Thermal Expansion (Linear, Area, Vol)"]}, 
                            {name:"DT-39 (XI)", subs:["Specific Heat Capacity", "Calorimetry Principles", "Change of State (Latent Heat)"]}, 
                            {name:"DT-40 (XI)", subs:["Heat Transfer: Conduction", "Thermal Conductivity", "Convection"]}, 
                            // UPDATED: Removed Stefan-Boltzmann, Newton's Law, Wien's Law
                            {name:"DT-41 (XI)", subs:["Heat Transfer: Radiation", " NOTE: Stefan/Newton/Wien Laws Deleted"]}
                        ] 
                    },
                    { 
                        subject: "Physics", 
                        topic: "Thermodynamics", 
                        dailyTests: [
                            {name:"DT-42 (XI)", subs:["Thermal Equilibrium", "Zeroth Law", "Internal Energy", "First Law of Thermodynamics"]}, 
                            {name:"DT-43 (XI)", subs:["Thermodynamic Processes (Isochoric, Isobaric, Isothermal, Adiabatic)", "Work Done"]}, 
                            // UPDATED: Removed Heat Engines, Refrigerators, Carnot
                            {name:"DT-44 (XI)", subs:["Second Law of Thermodynamics", " NOTE: Engines/Refrigerators/Carnot Deleted"]}
                        ] 
                    },
                    { 
                        subject: "Physics", 
                        topic: "Kinetic Theory", 
                        dailyTests: [
                            {name:"DT-45 (XI)", subs:["Molecular Nature of Matter", "Behavior of Gases", "Kinetic Theory Postulates", "Law of Equipartition of Energy", "Mean Free Path"]}
                        ] 
                    },
                    { 
                        subject: "Physics", 
                        topic: "Oscillations", 
                        dailyTests: [
                            {name:"DT-46 (XI)", subs:["Periodic & Oscillatory Motion", "SHM Equation", "Phase", "Uniform Circular Motion Reference"]}, 
                            {name:"DT-47 (XI)", subs:["Velocity & Acceleration in SHM", "Force Law", "Energy in SHM"]}, 
                            // UPDATED: Removed Damped & Forced Oscillations
                            {name:"DT-48 (XI)", subs:["Simple Pendulum", "Spring-Block Systems", "Resonance", " NOTE: Damped/Forced Oscillations Deleted"]}
                        ] 
                    },
                    { 
                        subject: "Physics", 
                        topic: "Waves", 
                        dailyTests: [
                            {name:"DT-49 (XI)", subs:["Transverse & Longitudinal Waves", "Amplitude & Phase", "Wavelength & Frequency"]}, 
                            {name:"DT-50 (XI)", subs:["Displacement Relation", "Speed of Travelling Wave", "Principle of Superposition"]}, 
                            // UPDATED: Removed Doppler Effect
                            {name:"DT-51 (XI)", subs:["Reflection of Waves", "Standing Waves", "Beats", " NOTE: Doppler Effect Deleted"]}
                        ] 
                    },
                    { 
                        subject: "Chemistry", 
                        topic: "Solutions", 
                        dailyTests: [
                            {name:"DT-1 (XII)", subs:["Types of Solutions", "Concentration Terms", "Solubility (Henry's Law)", "Vapour Pressure (Raoult's Law)"]}, 
                            {name:"DT-2 (XII)", subs:["Ideal & Non-Ideal Solutions", "Colligative Properties (RLVP, Elevation in BP, Depression in FP, Osmotic Pressure)", "Van't Hoff Factor"]}
                        ] 
                    },
                    { 
                        subject: "Chemistry", 
                        topic: "Kinetics", 
                        dailyTests: [
                            {name:"DT-7 (XII)", subs:["Rate of Reaction", "Factors Affecting Rate", "Rate Law & Constant", "Order & Molecularity"]}, 
                            {name:"DT-8 (XII)", subs:["Integrated Rate Equations (Zero & 1st Order)", "Half-Life", "Pseudo First Order", "Arrhenius Eq"]}, 
                            {name:"DT-9 (XII)", subs:["Effect of Catalyst", "Collision Theory of Chemical Reactions"]}
                        ] 
                    },
                    { 
                        subject: "Chemistry", 
                        topic: "Organic Basics", 
                        dailyTests: [
                            {name:"DT-23 (XI)", subs:["Classification of Organic Compounds", "Nomenclature (IUPAC)"]}, 
                            {name:"DT-24 (XI)", subs:["Isomerism", "Fission of Bond", "Nucleophiles & Electrophiles"]}, 
                            {name:"DT-25 (XI)", subs:["Inductive Effect", "Resonance Effect", "Electromeric Effect", "Hyperconjugation"]}, 
                            {name:"DT-26 (XI)", subs:["Reaction Intermediates: Carbocations, Carbanions, Free Radicals"]}, 
                            {name:"DT-27 (XI)", subs:["Types of Organic Reactions", "Purification Methods", "Qualitative & Quantitative Analysis"]}
                        ] 
                    },
                    { 
                        subject: "Botany", 
                        topic: "Photosynthesis", 
                        dailyTests: [
                            {name:"DT-26 (XI)", subs:["Early Experiments", "Site of Photosynthesis", "Pigments", "Light Reaction", "Electron Transport", "Splitting of Water", "Cyclic & Non-cyclic Photophos"]}, 
                            {name:"DT-27 (XI)", subs:["Chemiosmotic Hypothesis", "Biosynthetic Phase (C3 Cycle)", "C4 Pathway", "Photorespiration", "Factors affecting Photosynthesis"]}
                        ] 
                    },
                    { 
                        subject: "Botany", 
                        topic: "Respiration", 
                        dailyTests: [
                            {name:"DT-28 (XI)", subs:["Do Plants Breathe?", "Glycolysis", "Fermentation", "Aerobic Respiration", "TCA Cycle"]}, 
                            {name:"DT-29 (XI)", subs:["Electron Transport System (ETS)", "Oxidative Phosphorylation", "Amphibolic Pathway", "Respiratory Quotient"]}
                        ] 
                    },
                    { 
                        subject: "Botany", 
                        topic: "Plant Growth", 
                        dailyTests: [
                            {name:"DT-30 (XI)", subs:["Growth Phases & Rates", "Differentiation, Dedifferentiation, Redifferentiation", "Development"]}, 
                            {name:"DT-31 (XI)", subs:["Plant Growth Regulators: Auxins", "Gibberellins", "Cytokinins"]}, 
                            {name:"DT-32 (XI)", subs:["Ethylene", "Abscisic Acid", "Photoperiodism", "Vernalisation"]}
                        ] 
                    },
                    { 
                        subject: "Zoology", 
                        topic: "Chem Coordination", 
                        dailyTests: [
                            {name:"DT-25 (XI)", subs:["Endocrine Glands", "Hypothalamus", "Pituitary Gland"]}, 
                            {name:"DT-26 (XI)", subs:["Pineal", "Thyroid", "Parathyroid", "Thymus", "Adrenal"]}, 
                            {name:"DT-27 (XI)", subs:["Pancreas", "Testis", "Ovary"]}, 
                            {name:"DT-28 (XI)", subs:["Hormones of Heart/Kidney/GIT", "Mechanism of Hormone Action"]}
                        ] 
                    },
                    { 
                        subject: "Zoology", 
                        topic: "Animal Kingdom", 
                        dailyTests: [
                            {name:"DT-29 (XI)", subs:["Basis of Classification"]}, 
                            {name:"DT-30 (XI)", subs:["Phylum Porifera"]}, 
                            {name:"DT-31 (XI)", subs:["Phylum Coelenterata (Cnidaria)"]}, 
                            {name:"DT-32 (XI)", subs:["Phylum Ctenophora", "Phylum Platyhelminthes"]}, 
                            {name:"DT-33 (XI)", subs:["Phylum Aschelminthes", "Phylum Annelida"]}, 
                            {name:"DT-34 (XI)", subs:["Phylum Arthropoda", "Phylum Mollusca"]}, 
                            {name:"DT-35 (XI)", subs:["Phylum Echinodermata", "Phylum Hemichordata"]},
                            {name:"DT-36 (XI)", subs:["Chordata Intro", "Cyclostomata", "Chondrichthyes", "Osteichthyes"]}, 
                            {name:"DT-37 (XI)", subs:["Class Amphibia", "Class Reptilia"]},
                            {name:"DT-39 (XI)", subs:["Class Aves"]}, 
                            {name:"DT-40 (XI)", subs:["Class Mammalia"]}
                        ] 
                    },
                    { 
                        subject: "Zoology", 
                        topic: "Morphology", 
                        dailyTests: [
                            {name:"DT-41 (XI)", subs:["Cockroach: Morphology"]}, 
                            {name:"DT-42 (XI)", subs:["Cockroach: Digestive, Respiratory, Circulatory Systems"]}, 
                            {name:"DT-43 (XI)", subs:["Cockroach: Excretory, Nervous, Reproductive Systems"]}, 
                            {name:"DT-44 (XI)", subs:["Frog: Morphology & Anatomy (All Systems)"]}
                        ] 
                    }
                ]
            },
            {
                name: "UT-10",
                date: new Date('2026-02-01T00:00:00'),
                syllabus: [ /* Placeholder */ ]
            }
        ];       


        const backlogPlan = {
            name: "AIATS-5 Backlog",
            date: new Date('2026-02-01T00:00:00'),
            syllabus: [
                { 
                    subject: "Chemistry", 
                    topic: "Hydrocarbons", 
                    dailyTests: [
                        {name:"DT-28 (XI)", subs:["Alkanes: Nomenclature, Isomerism, Preparation", "Alkanes: Chemical Properties"]}, 
                        {name:"DT-29 (XI)", subs:["Alkenes: Structure, Preparation", "Alkenes: Chemical Properties (Markovnikov)"]}, 
                        {name:"DT-30 (XI)", subs:["Alkynes: Prep & Properties", "Aromatic Hydrocarbons: Benzene Structure & Prep", "Electrophilic Substitution", "Carcinogenicity"]}
                    ] 
                },
                { 
                    subject: "Chemistry", 
                    topic: "Haloalkanes", 
                    dailyTests: [
                        {name:"DT-17 (XII)", subs:["Nomenclature", "Nature of C-X Bond", "Methods of Preparation"]}, 
                        {name:"DT-18 (XII)", subs:["Chemical Reactions: Nucleophilic Substitution (SN1, SN2)", "Elimination Reactions", "Stereochemical Aspects"]}, 
                        {name:"DT-19 (XII)", subs:["Reaction with Metals", "Polyhalogen Compounds"]}
                    ] 
                },
                { 
                    subject: "Chemistry", 
                    topic: "Alcohols", 
                    dailyTests: [
                        {name:"DT-20 (XII)", subs:["Classification", "Nomenclature", "Preparation of Alcohols"]}, 
                        {name:"DT-21 (XII)", subs:["Phenols: Preparation", "Physical Properties", "Chemical Properties (Acidity)"]}, 
                        {name:"DT-22 (XII)", subs:["Ethers: Preparation", "Physical & Chemical Properties", "Uses"]}
                    ] 
                },
                { 
                    subject: "Chemistry", 
                    topic: "Aldehydes", 
                    dailyTests: [
                        {name:"DT-23 (XII)", subs:["Aldehydes & Ketones: Prep", "Physical Properties", "Nucleophilic Addition"]}, 
                        {name:"DT-24 (XII)", subs:["Carboxylic Acids: Nomenclature, Prep", "Physical & Chemical Properties"]}
                    ] 
                },
                { 
                    subject: "Botany", 
                    topic: "Sexual Repro", 
                    dailyTests: [
                        {name:"DT-1 (XII)", subs:["Flower Structure", "Pre-fertilization: Stamen, Microsporangium", "Pollen Grain"]}, 
                        {name:"DT-2 (XII)", subs:["Pistil, Megasporangium (Ovule)", "Embryo Sac"]}, 
                        {name:"DT-3 (XII)", subs:["Pollination: Types, Agents", "Outbreeding Devices", "Pollen-Pistil Interaction"]}, 
                        {name:"DT-4 (XII)", subs:["Double Fertilization", "Post-fertilization: Endosperm & Embryo"]}, 
                        {name:"DT-5 (XII)", subs:["Seed & Fruit Formation", "Apomixis & Polyembryony"]}
                    ] 
                },
                { 
                    subject: "Botany", 
                    topic: "Genetics I", 
                    dailyTests: [
                        {name:"DT-6 (XII)", subs:["Mendel's Laws of Inheritance", "Inheritance of One Gene"]}, 
                        {name:"DT-7 (XII)", subs:["Incomplete Dominance", "Co-dominance", "Inheritance of Two Genes"]}, 
                        {name:"DT-8 (XII)", subs:["Chromosomal Theory of Inheritance", "Linkage & Recombination", "Sex Determination"]}, 
                        {name:"DT-9 (XII)", subs:["Mutation", "Pedigree Analysis", "Genetic Disorders (Mendelian & Chromosomal)"]}
                    ] 
                },
                { 
                    subject: "Zoology", 
                    topic: "Human Repro", 
                    dailyTests: [
                        {name:"DT-1 (XII)", subs:["Male Reproductive System"]}, 
                        {name:"DT-2 (XII)", subs:["Female Reproductive System", "Mammary Glands"]}, 
                        {name:"DT-3 (XII)", subs:["Gametogenesis: Spermatogenesis & Oogenesis"]}, 
                        {name:"DT-4 (XII)", subs:["Menstrual Cycle", "Fertilization & Implantation"]}, 
                        {name:"DT-5 (XII)", subs:["Pregnancy & Embryonic Development", "Parturition & Lactation"]}
                    ] 
                },
                { 
                    subject: "Zoology", 
                    topic: "Repro Health", 
                    dailyTests: [
                        {name:"DT-7 (XII)", subs:["Reproductive Health: Problems & Strategies", "Population Explosion"]}, 
                        {name:"DT-8 (XII)", subs:["Birth Control Methods", "Medical Termination of Pregnancy (MTP)"]}, 
                        {name:"DT-9 (XII)", subs:["Sexually Transmitted Infections (STIs)", "Infertility", "Assisted Reproductive Technologies (ART)"]}
                    ] 
                }
            ]
        };

        // --- STATE MODIFICATION: USE REAL DATE ---
        const state = {
            // UPDATED: Now uses current real-world date
            
            displayName: null,
            currentDate: new Date(), 
            selectedDate: new Date(),
            tasks: {}, 
            prayers: {},
            activeView: 'overview',
            nextExam: null,
            dailyTestsAttempted: {},
            expandedTests: {}, 
            expandedFocusGroups: {},
            goalCompletedToday: false, // Track if sound played
            mistakes: [], // NEW: Array for mistakes
            activeNotebook: null // NEW: Currently open subject
        };

        // --- FIXED: ADDED ESCAPE HELPERS FOR SECURITY ---
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const escapeRegex = (string) => {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        };

        // Escape function to prevent crashes with quotes
        const escape = (str) => {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '&quot;');
        };

        const formatDateKey = (d) => {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        function getSubjectColor(subject) {
            switch(subject) {
                case 'Physics': return 'bg-phy-100 dark:bg-phy-700/30 text-phy-700 dark:text-phy-100';
                case 'Chemistry': return 'bg-chem-100 dark:bg-chem-700/30 text-chem-700 dark:text-chem-100';
                case 'Botany': return 'bg-bio-100 dark:bg-bio-700/30 text-bio-700 dark:text-bio-100';
                case 'Zoology': return 'bg-bio-100 dark:bg-bio-700/30 text-bio-700 dark:text-bio-100';
                default: return 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200';
            }
        }
// --- NEW PROFILE UI LOGIC ---
window.updateProfileUI = function(user) {
    const isGuest = !user || user.isAnonymous;
    const name = state.displayName || (user && user.email ? user.email.split('@')[0] : "Guest User");
    const initial = name.charAt(0).toUpperCase();

    const guestStyle = {
        cardBorder: "border-slate-200 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-800",
        avatarBg: "bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400",
        icon: "log-in"
    };

    const userStyle = {
        cardBorder: "border-brand-200 dark:border-brand-900/50 bg-brand-50/50 dark:bg-brand-900/10",
        avatarBg: "bg-gradient-to-br from-brand-500 to-blue-600 text-white shadow-brand-500/30",
        icon: "log-out"
    };

    const currentStyle = isGuest ? guestStyle : userStyle;

    const updateElements = (prefix) => {
        const card = document.getElementById(`${prefix}-user-card`);
        const avatarBg = document.getElementById(`${prefix}-user-avatar-bg`);
        const avatarText = document.getElementById(`${prefix}-user-avatar-text`);
        const nameEl = document.getElementById(`${prefix}-user-name`);
        const statusEl = document.getElementById(`${prefix}-sync-status`);
        const btn = document.getElementById(`${prefix}-auth-btn`);

        if(!card) return;

        if(prefix === 'mobile') {
            card.className = `flex items-center gap-3 px-3 py-3 rounded-2xl border transition-all cursor-pointer ${currentStyle.cardBorder}`;
        }
        
        avatarBg.className = `flex items-center justify-center font-bold shadow-sm transition-colors ${prefix === 'mobile' ? 'w-10 h-10 rounded-full text-sm' : 'w-9 h-9 rounded-xl text-xs'} ${currentStyle.avatarBg}`;
        avatarText.textContent = isGuest ? "?" : initial;
        nameEl.textContent = name;
        
        statusEl.innerHTML = isGuest 
            ? `<span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> <span class="text-slate-500 dark:text-slate-400">Local Only</span>`
            : `<span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> <span class="text-green-600 dark:text-green-400">Synced</span>`;

        btn.innerHTML = `<i data-lucide="${currentStyle.icon}" class="${prefix === 'mobile' ? 'w-5 h-5' : 'w-4 h-4'}"></i>`;
        
        if(isGuest) {
            btn.className = `${prefix === 'mobile' ? 'p-2' : 'p-1.5'} rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-lg hover:scale-105 transition-all`;
        } else {
            btn.className = `${prefix === 'mobile' ? 'p-2' : 'p-1.5'} rounded-xl text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all`;
        }
    };

    updateElements('mobile');
    updateElements('desktop');
    if(window.lucide) lucide.createIcons();
};

window.handleProfileClick = function() {
    if (!currentUser || currentUser.isAnonymous) document.getElementById('auth-modal').classList.remove('hidden');
};

window.handleAuthAction = function(e) {
    e.stopPropagation(); 
    if (!currentUser || currentUser.isAnonymous) document.getElementById('auth-modal').classList.remove('hidden');
    else handleLogout();
};
        function init() {
            // FIX: This must run FIRST to prevent the crash
            setupSchedule(); 

            if (!isFirebaseActive && !localStorage.getItem('studyflow_demo_mode')) {
                document.getElementById('auth-modal').classList.remove('hidden');
                if(window.lucide) lucide.createIcons();
                return;
            }

            if(isFirebaseActive) {
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    
                    if (user) {
                        document.getElementById('auth-modal').classList.add('hidden');
                        const docRef = getSafeDocRef(user.uid);
                        
                        unsubscribeDoc = onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                state.tasks = data.tasks || {};
                                state.dailyTestsAttempted = data.dailyTestsAttempted || {};
                                state.mistakes = data.mistakes || []; 
                                state.prayers = data.prayers || {};
                                state.displayName = data.displayName || null;
                                
                                updateProfileUI(user); // Updates UI to "User Mode"
                                renderAll();
                            } else {
                                saveData();
                                updateProfileUI(user);
                            }
                        }, (error) => {
                            console.error("Firestore error fallback:", error);
                            initLocalMode();
                        });   
                    } else {
                        updateProfileUI(null); // Updates UI to "Guest Mode"
                        document.getElementById('auth-modal').classList.remove('hidden');
                    }
                });
            } else {
                initLocalMode();
            }

            // Setup Mistake Form Listener
            const mistakeForm = document.getElementById('mistake-form');
            if(mistakeForm) {
                const newMForm = mistakeForm.cloneNode(true);
                mistakeForm.parentNode.replaceChild(newMForm, mistakeForm);
                newMForm.addEventListener('submit', window.saveMistake);
            }
        }
function initLocalMode() {
        const storedPrayers = localStorage.getItem('studyflow_prayers');
        if (storedPrayers) state.prayers = JSON.parse(storedPrayers);
        try {
            const storedTasks = localStorage.getItem('studyflow_tasks_v2');
            if (storedTasks) state.tasks = JSON.parse(storedTasks);
            
            const storedAttempts = localStorage.getItem('studyflow_attempts_v2'); 
            if (storedAttempts) state.dailyTestsAttempted = JSON.parse(storedAttempts);
            
            const storedMistakes = localStorage.getItem('studyflow_mistakes'); 
            if (storedMistakes) state.mistakes = JSON.parse(storedMistakes);

            const storedName = localStorage.getItem('studyflow_username');
            if (storedName) state.displayName = storedName;
            
        } catch (e) {
            console.error("Local data corrupted", e);
            localStorage.removeItem('studyflow_tasks_v2');
        }
        renderAll();
    }
        function setupSchedule() {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Find next exam based on REAL date
            state.nextExam = mainSchedule.find(e => {
                const ed = new Date(e.date); ed.setHours(0,0,0,0);
                return ed >= today;
            }) || mainSchedule[mainSchedule.length-1];

            const addTaskForm = document.getElementById('add-task-form');
            if(addTaskForm) {
                const newForm = addTaskForm.cloneNode(true);
                addTaskForm.parentNode.replaceChild(newForm, addTaskForm);
                newForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const inp = document.getElementById('new-task-input');
                    const typeSelect = document.getElementById('new-task-type');
                    const subSelect = document.getElementById('new-task-subject');
                    if(inp.value.trim()) { 
                        addTask(inp.value.trim(), typeSelect.value, subSelect.value); 
                        inp.value = ''; 
                    }
                });
            }

            // Setup Mistake Form Listener
            const mistakeForm = document.getElementById('mistake-form');
            if(mistakeForm) {
                const newMForm = mistakeForm.cloneNode(true);
                mistakeForm.parentNode.replaceChild(newMForm, mistakeForm);
                newMForm.addEventListener('submit', window.saveMistake);
            }
        }
// --- NEW HELPER: CALCULATE STATS ---
    function calculateUserStats() {
        // 1. Calculate Main Exam %
        const allCompleted = new Set(Object.values(state.tasks).flat().filter(t => t.completed).map(t => t.text));
        let mainTotal = 0, mainDone = 0;
        state.nextExam.syllabus.forEach(s => s.dailyTests.forEach(dt => dt.subs.forEach(sub => {
            mainTotal++;
            if(allCompleted.has(`Study: ${s.topic} - ${sub}`)) mainDone++;
        })));
        const mainPct = mainTotal ? Math.round((mainDone/mainTotal)*100) : 0;

        // 2. Calculate Backlog %
        let blTotal = 0, blDone = 0;
        backlogPlan.syllabus.forEach(s => s.dailyTests.forEach(dt => dt.subs.forEach(sub => {
            blTotal++;
            if(allCompleted.has(`Study: ${s.topic} - ${sub}`)) blDone++;
        })));
        const blPct = blTotal ? Math.round((blDone/blTotal)*100) : 0;

        // 3. Count Tests
        const testCount = Object.keys(state.dailyTestsAttempted).filter(k => state.dailyTestsAttempted[k]).length;

        // 4. Calculate Overall Score
        const overallScore = (mainPct * 5) + (blPct * 3) + (testCount * 10);

        return { mainPct, blPct, testCount, overallScore };
    }
 function saveData() {
            const stats = calculateUserStats(); // Calculate stats first

            if(isFirebaseActive && currentUser) {
                const docRef = getSafeDocRef(currentUser.uid);
                
                // Show saving indicator
                const statusEl = document.getElementById('desktop-sync-status');
                if(statusEl) statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span> Saving...`;

                // 1. Save Personal Data (Private)
                setDoc(docRef, {
                    tasks: state.tasks,
                    dailyTestsAttempted: state.dailyTestsAttempted,
                    mistakes: state.mistakes || [],
                    displayName: state.displayName,
prayers: state.prayers || {} // <--- SAVING NAME PRIVATELY
                }, { merge: true }).then(() => {
                    if(statusEl) statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Synced`;
                }).catch(err => {
                    console.error("Save failed:", err);
                    if(statusEl) statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Save Failed`;
                });

                // 2. Save Leaderboard Entry (PUBLIC - This is what was missing)
                const lbRef = doc(db, 'leaderboard', currentUser.uid);
                setDoc(lbRef, {
                    email: currentUser.email || 'Anonymous',
                    displayName: state.displayName || 'Anonymous', // <--- SAVING NAME PUBLICLY
                    ...stats,
                    lastUpdated: new Date()
                }, { merge: true });

            } else {
                localStorage.setItem('studyflow_tasks_v2', JSON.stringify(state.tasks));
                localStorage.setItem('studyflow_attempts_v2', JSON.stringify(state.dailyTestsAttempted));
                localStorage.setItem('studyflow_mistakes', JSON.stringify(state.mistakes || []));
                localStorage.setItem('studyflow_username', state.displayName); // Save locally
localStorage.setItem('studyflow_prayers', JSON.stringify(state.prayers || {}));
            }
            renderAll();
        }      

 // --- PRAYER FUNCTIONS ---
window.openPrayerModal = function() {
    document.getElementById('modal-prayer-date').textContent = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' });
    document.getElementById('prayer-modal').classList.remove('hidden');
    renderPrayerModalItems();
};

window.togglePrayer = function(prayerName) {
    const k = formatDateKey(state.selectedDate);
    if (!state.prayers[k]) state.prayers[k] = {};
    state.prayers[k][prayerName] = !state.prayers[k][prayerName];
    saveData();
    renderPrayerModalItems();
    updateHeaderPrayerBtn();
};

window.renderPrayerModalItems = function() {
    const list = document.getElementById('modal-prayer-list');
    if(!list) return;
    const k = formatDateKey(state.selectedDate);
    const todayData = state.prayers[k] || {};
    const prayers = [
        { name: 'Fajr', time: 'Before Sunrise' }, { name: 'Dhuhr', time: 'After Noon' },
        { name: 'Asr', time: 'Afternoon' }, { name: 'Maghrib', time: 'After Sunset' }, { name: 'Isha', time: 'Night' }
    ];
    list.innerHTML = prayers.map(p => {
        const isDone = todayData[p.name] === true;
        const bg = isDone ? "bg-emerald-500 border-emerald-600 text-white" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400";
        return `<button onclick="togglePrayer('${p.name}')" class="flex items-center justify-between p-3 rounded-xl border transition-all ${bg}">
            <div class="text-left"><div class="font-bold text-sm ${isDone ? 'text-white' : 'text-slate-800 dark:text-white'}">${p.name}</div><div class="text-[10px] font-bold uppercase tracking-wider ${isDone ? 'text-emerald-100' : 'text-slate-400'}">${p.time}</div></div>
            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isDone ? 'border-white bg-white text-emerald-600' : 'border-slate-300 dark:border-slate-600'}">${isDone ? '<i data-lucide="check" class="w-3.5 h-3.5"></i>' : ''}</div></button>`;
    }).join('');
    if(window.lucide) lucide.createIcons({ root: list });
};

window.updateHeaderPrayerBtn = function() {
    const el = document.getElementById('header-prayer-count');
    if(!el) return;
    const k = formatDateKey(state.selectedDate);
    const todayData = state.prayers[k] || {};
    const count = Object.values(todayData).filter(v => v === true).length;
    el.textContent = `${count}/5`;
    if(count === 5) el.className = "bg-yellow-400 text-black text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold shadow-sm";
    else el.className = "bg-emerald-600 text-white text-[9px] px-1.5 py-0.5 rounded ml-1";
};
// --- SPIRITUAL DASHBOARD LOGIC ---
window.renderNamazView = function() {
    // --- PART 1: THE "HOLY LIGHT" RAMADAN TIMER ---
    if (typeof window.ramadanTimerInterval === 'undefined') window.ramadanTimerInterval = null;
    if (window.ramadanTimerInterval) clearInterval(window.ramadanTimerInterval);

    const countEl = document.getElementById('ramadan-days-left');
    const ramadanDate = new Date('2026-02-17T00:00:00');

    // 1. VISUAL UPGRADE: Make the card glow
    if (countEl) {
        const card = countEl.closest('.rounded-3xl'); // Find the main card container
        if (card) {
            // Apply new "Ramadan" styling (Brighter Green + Gold Glow + Glass Border)
            card.className = "bg-gradient-to-br from-emerald-500 via-teal-600 to-emerald-800 rounded-3xl p-8 text-white shadow-2xl shadow-emerald-400/40 relative overflow-hidden group border border-emerald-400/30 transition-all duration-500";
            
            // Find the background lantern and make it Golden
            const lanternContainer = card.querySelector('.absolute');
            if(lanternContainer) {
                // Add a golden drop-shadow to the lantern icon
                lanternContainer.innerHTML = '<i data-lucide="lamp-ceiling" class="w-64 h-64 text-amber-200/20 drop-shadow-[0_0_30px_rgba(251,191,36,0.4)] transform rotate-12 transition-transform duration-700 group-hover:rotate-0"></i>';
                if(window.lucide) lucide.createIcons({ root: lanternContainer });
            }
        }
    }

    const updateTimer = () => {
        const now = new Date();
        const diff = ramadanDate - now;
        if (diff <= 0) {
            if(countEl) countEl.innerHTML = "<span class='text-amber-200 font-bold text-2xl drop-shadow-md'>Ramadan Mubarak! </span>";
            return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        
        // NEW STYLING: Gold Borders & Brighter Text
        const makeBox = (val, label) => `
            <div class="flex flex-col items-center justify-center bg-black/20 rounded-xl border border-amber-200/30 p-2 min-w-[55px] md:min-w-[65px] backdrop-blur-md shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                <span class="text-2xl md:text-3xl font-bold text-white font-mono leading-none drop-shadow-sm">${String(val).padStart(2, '0')}</span>
                <span class="text-[9px] font-bold text-amber-300 uppercase mt-1 tracking-widest">${label}</span>
            </div>`;
            
        if (countEl) {
            if (countEl.parentElement && countEl.nextElementSibling) {
                countEl.nextElementSibling.style.display = 'none';
                countEl.parentElement.classList.remove('p-4', 'min-w-[120px]');
                countEl.parentElement.classList.add('p-0', 'pl-0', 'md:pl-6'); // Adjust alignment
            }
            countEl.innerHTML = `
                <div class="flex gap-2 items-center">
                    ${makeBox(d,'Day')}
                    <span class="text-amber-200/60 font-bold text-xl pb-4 animate-pulse">:</span>
                    ${makeBox(h,'Hr')}
                    <span class="text-amber-200/60 font-bold text-xl pb-4 animate-pulse">:</span>
                    ${makeBox(m,'Min')}
                    <span class="text-amber-200/60 font-bold text-xl pb-4 animate-pulse hidden md:block">:</span>
                    ${makeBox(s,'Sec')}
                </div>`;
        }
    };
    updateTimer();
    window.ramadanTimerInterval = setInterval(updateTimer, 1000);


    // --- PART 2: DATA DASHBOARD (Preserved) ---
    const calculateStats = (days) => {
        const counts = { Fajr: 0, Dhuhr: 0, Asr: 0, Maghrib: 0, Isha: 0 };
        let total = 0, streak = 0, streakBroken = false;
        for(let i=0; i<days; i++) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const k = formatDateKey(d);
            let dailyCount = 0;
            if(state.prayers && state.prayers[k]) {
                const p = state.prayers[k];
                ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(name => {
                    if(p[name]) { counts[name]++; dailyCount++; }
                });
            }
            total += dailyCount;
            if(!streakBroken) {
                if(dailyCount > 0) streak++;
                else if(i > 0) streakBroken = true;
            }
        }
        return { counts, total, streak, rate: Math.round((total / (days * 5)) * 100) };
    };

    const stats = calculateStats(30);
    const entries = Object.entries(stats.counts);
    entries.sort((a, b) => b[1] - a[1]);

    let bestName = "None yet";
    let worstName = "All";
    
    if (stats.total > 0) {
        bestName = entries[0][0]; 
        worstName = stats.rate === 100 ? "None!" : entries[entries.length-1][0];
    }

    const oldInsightCard = document.getElementById('insight-best');
    if (oldInsightCard) {
        const gridContainer = oldInsightCard.closest('.grid');
        if (gridContainer && !gridContainer.classList.contains('dashboard-active')) {
            const dashboardHTML = `
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center shadow-sm">
                        <div class="text-2xl md:text-3xl font-black text-brand-600 dark:text-brand-400">${stats.total}</div>
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Prayers (30d)</div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center shadow-sm">
                        <div class="text-2xl md:text-3xl font-black text-emerald-500">${stats.rate}%</div>
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Consistency</div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 text-center shadow-sm">
                        <div class="text-2xl md:text-3xl font-black text-orange-500">${stats.streak}</div>
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Day Streak</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 flex items-center gap-3 shadow-sm">
                        <div class="p-3 bg-green-100 dark:bg-green-900/20 rounded-full text-green-600 dark:text-green-400"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                        <div><div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Strongest</div><div class="text-lg font-bold text-slate-900 dark:text-white">${bestName}</div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 flex items-center gap-3 shadow-sm">
                        <div class="p-3 bg-red-100 dark:bg-red-900/20 rounded-full text-red-600 dark:text-red-400"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                        <div><div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Needs Focus</div><div class="text-lg font-bold text-slate-900 dark:text-white">${worstName}</div></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm mb-4">
                    <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-slate-400"></i> Prayer Frequency</h3>
                    <div class="space-y-4">
                        ${['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].map(p => {
                            const count = stats.counts[p] || 0;
                            const pct = (count / 30) * 100;
                            let color = pct >= 80 ? 'bg-emerald-500' : (pct >= 50 ? 'bg-brand-500' : 'bg-orange-400');
                            return `<div><div class="flex justify-between text-xs font-bold mb-1.5"><span class="text-slate-600 dark:text-slate-300 w-16">${p}</span><span class="text-slate-400">${count}/30 days</span></div><div class="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden"><div class="h-full ${color} transition-all duration-1000" style="width: ${pct}%"></div></div></div>`;
                        }).join('')}
                    </div>
                </div>`;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = dashboardHTML;
            wrapper.classList.add('dashboard-active');
            gridContainer.replaceWith(wrapper);
            if(window.lucide) lucide.createIcons({ root: wrapper });
        }
    }

    renderDailyHadith();
};

function calculatePrayerStats() {
    if(!state.prayers) return;

    const counts = { Fajr: 0, Dhuhr: 0, Asr: 0, Maghrib: 0, Isha: 0 };
    const totalDays = 30; // Look back period
    let daysChecked = 0;

    // Iterate backwards 30 days
    for(let i=0; i<totalDays; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = formatDateKey(d);
        
        if(state.prayers[k]) {
            daysChecked++;
            const p = state.prayers[k];
            if(p.Fajr) counts.Fajr++;
            if(p.Dhuhr) counts.Dhuhr++;
            if(p.Asr) counts.Asr++;
            if(p.Maghrib) counts.Maghrib++;
            if(p.Isha) counts.Isha++;
        }
    }

    // Determine Best & Worst
    let bestName = "None yet";
    let bestCount = -1;
    let worstName = "None";
    let worstCount = 999;

    Object.entries(counts).forEach(([name, count]) => {
        if(count > bestCount) { bestCount = count; bestName = name; }
        if(count < worstCount) { worstCount = count; worstName = name; }
    });

    // Update UI
    const bestEl = document.getElementById('insight-best');
    const worstEl = document.getElementById('insight-worst');

    if(bestEl) {
        if (bestCount === 0) bestEl.textContent = "Start Today";
        else bestEl.textContent = bestName;
    }

    if(worstEl) {
        if (bestCount === 0) worstEl.textContent = "All Prayers";
        else if (worstCount === bestCount) worstEl.textContent = "Consistent"; // All equal
        else worstEl.textContent = worstName;
    }
}

function renderDailyHadith() {
    const hadiths = [
        { text: "The difference between a man and shirk and kufr is the abandoning of the Prayer.", source: "Sahih Muslim" },
        { text: "The first matter that the slave will be brought to account for on the Day of Judgment is the Prayer.", source: "Sahih Al-Jami" },
        { text: "He who prays the two cool prayers (Asr and Fajr) will enter Paradise.", source: "Sahih Bukhari" },
        { text: "No one who prays before the rising of the sun and before its setting will enter the Fire.", source: "Sahih Muslim" },
        { text: "Between faith and unbelief is abandoning the prayer.", source: "Sahih Muslim" },
        { text: "Whoever misses the Asr prayer, it is as if he has lost his family and his wealth.", source: "Sahih Bukhari" }
    ];

    // Pick based on day of month to rotate consistently
    const dayIndex = new Date().getDate() % hadiths.length;
    const selected = hadiths[dayIndex];

    const textEl = document.getElementById('daily-hadith-text');
    const sourceEl = document.getElementById('daily-hadith-source');

    if(textEl) textEl.textContent = `"${selected.text}"`;
    if(sourceEl) sourceEl.textContent = selected.source;
}
        // Global functions
        window.addTask = function(text, type = 'main', subject = 'General', chapter = null) {
            const key = formatDateKey(state.selectedDate);
            if (!state.tasks[key]) state.tasks[key] = [];
            state.tasks[key].push({
                id: Date.now() + Math.random().toString(36).substr(2, 9), 
                text, type, subject, chapter, completed: false 
            });
            saveData();
        };

        window.deleteTask = function(id) {
            const key = formatDateKey(state.selectedDate);
            if(state.tasks[key]) {
                state.tasks[key] = state.tasks[key].filter(t => t.id !== id);
                saveData();
            }
        };

        window.deleteGroup = function(chapterName) {
            const key = formatDateKey(state.selectedDate);
            if(state.tasks[key]) {
                 state.tasks[key] = state.tasks[key].filter(t => {
                    let chap = t.chapter;
                    if (!chap && t.text.startsWith("Study: ")) {
                        const parts = t.text.replace("Study: ", "").split(" - ");
                        if (parts.length > 1) chap = parts[0];
                    }
                    return chap !== chapterName;
                });
                saveData();
                if (state.expandedFocusGroups[chapterName]) delete state.expandedFocusGroups[chapterName];
            }
        };

        window.toggleTask = function(id) {
            const key = formatDateKey(state.selectedDate);
            if(state.tasks[key]) {
                const t = state.tasks[key].find(x => x.id === id);
                if(t) { t.completed = !t.completed; saveData(); }
            }
        };

        window.toggleFocusGroup = function(chapterName) {
            state.expandedFocusGroups[chapterName] = !state.expandedFocusGroups[chapterName];
            renderTasks(); // Re-renders only the tasks list
        };

        window.toggleTestAttempt = function(testName) {
            // FIXED: Explicitly set to false instead of deleting key so that { merge: true } updates the DB correctly
            if (state.dailyTestsAttempted[testName]) {
                 state.dailyTestsAttempted[testName] = false; 
            } else {
                 state.dailyTestsAttempted[testName] = true;
            }
            saveData();
        };

 window.switchView = function(view) {
    state.activeView = view;
    toggleMobileMenu(true); 
    
    // NEW: Handle Leaderboard
    if(view === 'leaderboard') {
        fetchLeaderboard();
        switchRankTab('overall'); 
    }
if(view === 'namaz') {
        renderNamazView();
    }
    // Reset Notebook if leaving mistakes view
    if(view === 'mistakes') {
        closeNotebook(); 
    }

    // Updated list to include 'leaderboard'
    ['overview','target','backlog', 'mistakes', 'leaderboard', 'namaz'].forEach(v => {
        const btn = document.getElementById(`nav-${v}`);
        if(btn) {
            if(v === view) btn.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-sm transition-all bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400 shadow-sm";
            else btn.className = "w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white transition-all";
        }
        const viewEl = document.getElementById(`view-${v}`);
        if(viewEl) viewEl.classList.add('hidden');
    });

    const activeEl = document.getElementById(`view-${view}`);
    if(activeEl) activeEl.classList.remove('hidden');
    
    // Only render standard views if NOT leaderboard
    if(view !== 'leaderboard') renderAll();
};       



        window.toggleMobileMenu = function(forceClose = false) {
            const body = document.getElementById('app-body');
            if (forceClose) { body.classList.remove('menu-open'); body.classList.add('menu-closed'); } 
            else {
                if (body.classList.contains('menu-open')) { body.classList.remove('menu-open'); body.classList.add('menu-closed'); } 
                else { body.classList.remove('menu-closed'); body.classList.add('menu-open'); }
            }
        };
        
        // --- BOOKSHELF FUNCTIONS ---

        window.openNotebook = function(subject) {
            state.activeNotebook = subject;
            
            // UI Transitions
            document.getElementById('notebook-shelf').classList.add('hidden');
            document.getElementById('notebook-content').classList.remove('hidden');
            
            // Set Headers
            document.getElementById('notebook-title').textContent = `${subject} Notebook`;
            document.getElementById('mistake-subject-display').value = subject;
            
            // Dynamic Header Colors
            const headerBg = document.getElementById('notebook-header-bg');
            if(subject === 'Physics') headerBg.className = "px-6 py-4 border-b border-blue-100 dark:border-blue-900 flex items-center justify-between transition-colors bg-blue-50 dark:bg-blue-900/20";
            else if(subject === 'Chemistry') headerBg.className = "px-6 py-4 border-b border-orange-100 dark:border-orange-900 flex items-center justify-between transition-colors bg-orange-50 dark:bg-orange-900/20";
            else headerBg.className = "px-6 py-4 border-b border-green-100 dark:border-green-900 flex items-center justify-between transition-colors bg-green-50 dark:bg-green-900/20";

            renderNotebookEntries();
        };

        window.closeNotebook = function() {
            state.activeNotebook = null;
            document.getElementById('notebook-content').classList.add('hidden');
            document.getElementById('notebook-shelf').classList.remove('hidden');
            updateShelfCounts();
        };

        // --- IMAGE HANDLING ---

        window.handleImageUpload = function(input) {
            const file = input.files[0];
            if (file) {
                // INCREASED SIZE LIMIT: 800KB (approx 800,000 bytes)
                // This balances larger images with storage stability.
                if(file.size > 800000) {
                    alert("Image is too large! Please use an image under 800KB.");
                    input.value = ''; // clear
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show preview
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    document.getElementById('image-preview-container').classList.remove('hidden');
                    document.getElementById('image-preview').src = e.target.result;
                    // Store base64 string in hidden input
                    document.getElementById('mistake-image-base64').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        window.clearImage = function() {
            document.getElementById('mistake-file').value = '';
            document.getElementById('mistake-image-base64').value = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('image-preview-container').classList.add('hidden');
            // Prevent event bubbling if clicking the X
            if(event) event.stopPropagation(); 
        };

        window.viewFullImage = function(src) {
            document.getElementById('full-size-image').src = src;
            document.getElementById('image-viewer-modal').classList.remove('hidden');
        };

        // --- MISTAKE RENDERING & SAVING ---

        window.saveMistake = function(e) {
            e.preventDefault();
            if(!state.activeNotebook) return;

            const type = document.getElementById('mistake-type').value;
            const chapter = document.getElementById('mistake-chapter').value;
            const desc = document.getElementById('mistake-desc').value;
            const answer = document.getElementById('mistake-answer').value; // NEW
            const imgData = document.getElementById('mistake-image-base64').value;

            if(!chapter || !desc) {
                alert("Please fill in Chapter and Question Description");
                return;
            }

            const newMistake = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                subject: state.activeNotebook,
                chapter: chapter,
                type: type,
                desc: desc,
                answer: answer, // NEW
                image: imgData,
                resolved: false
            };

            if(!state.mistakes) state.mistakes = [];
            state.mistakes.unshift(newMistake);

            // Reset Form
            document.getElementById('mistake-form').reset();
            clearImage();
            document.getElementById('add-mistake-modal').classList.add('hidden');

            saveData();
            renderNotebookEntries();
            updateShelfCounts();
        };
        
        window.deleteMistake = function(id) {
            if(confirm("Delete this entry?")) {
                state.mistakes = state.mistakes.filter(m => m.id !== id);
                saveData();
                renderNotebookEntries();
            }
        };

        window.toggleMistakeResolved = function(id) {
            const m = state.mistakes.find(m => m.id === id);
            if(m) {
                m.resolved = !m.resolved;
                saveData();
                renderNotebookEntries();
                updateShelfCounts();
            }
        };

        window.renderNotebookEntries = function() {
            const list = document.getElementById('notebook-entries');
            if(!list || !state.activeNotebook) return;

            list.innerHTML = '';
            
            // Filter by the currently open notebook (Subject)
            const entries = (state.mistakes || []).filter(m => m.subject === state.activeNotebook);

            if(entries.length === 0) {
                list.innerHTML = `
                    <div class="h-64 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 opacity-60">
                        <i data-lucide="book-open" class="w-12 h-12 mb-3"></i>
                        <p>No errors logged in ${state.activeNotebook} yet.</p>
                    </div>`;
            }

            entries.forEach(m => {
                const dateStr = new Date(m.date).toLocaleDateString();
                
                let typeBadge = 'bg-slate-200 text-slate-700';
                if(m.type === 'Conceptual') typeBadge = 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300';
                if(m.type === 'Silly') typeBadge = 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300';
                if(m.type === 'Memory') typeBadge = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300';

                const html = `
                    <div class="bg-white dark:bg-slate-900 border ${m.resolved ? 'border-green-200 dark:border-green-900' : 'border-slate-200 dark:border-slate-800'} rounded-xl p-0 shadow-sm overflow-hidden group">
                        <div class="p-4 flex flex-col md:flex-row gap-4">
                            <!-- Text Content -->
                             <div class="flex-1 min-w-0">
    <div class="flex items-center gap-2">
        <p class="text-sm font-bold text-slate-900 dark:text-white truncate max-w-[110px]" id="mobile-user-email">Guest</p>
        <button onclick="openProfileModal()" class="shrink-0 p-1.5 bg-brand-100 dark:bg-brand-900 text-brand-700 dark:text-brand-300 rounded-lg hover:bg-brand-200 transition-colors" aria-label="Edit Profile">
            <i data-lucide="edit-3" class="w-4 h-4"></i>
        </button>
    </div>
    <p class="text-[10px] font-medium text-slate-500 dark:text-slate-400" id="mobile-sync-status">Local Storage</p>
</div>                               
                                <div class="mb-2">
                                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Question / Mistake</p>
                                    <p class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap ${m.resolved ? 'line-through opacity-60' : ''}">${escapeHtml(m.desc)}</p>
                                </div>
                                
                                <div id="answer-container-${m.id}" class="hidden mt-4 pt-3 border-t border-slate-100 dark:border-slate-800 border-dashed">
                                    <p class="text-xs font-bold text-green-600 dark:text-green-400 uppercase mb-1">Correct Answer / Explanation</p>
                                    <p class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">${escapeHtml(m.answer || 'No answer recorded.')}</p>
                                </div>
                                
                                <button onclick="document.getElementById('answer-container-${m.id}').classList.remove('hidden'); this.classList.add('hidden')" class="mt-3 text-xs font-bold text-brand-600 dark:text-brand-400 hover:underline flex items-center gap-1">
                                    <i data-lucide="eye" class="w-3 h-3"></i> Reveal Answer
                                </button>
                            </div>
                            
                            <!-- Thumbnail (if exists) -->
                            ${m.image ? `
                                <div class="w-24 h-24 flex-shrink-0 cursor-zoom-in border border-slate-100 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 relative group/img" onclick="viewFullImage('${m.image}')">
                                    <img src="${m.image}" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black/0 group-hover/img:bg-black/10 transition-colors"></div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Actions Footer -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 px-4 py-2 flex justify-between items-center border-t border-slate-100 dark:border-slate-800">
                            <button onclick="deleteMistake('${m.id}')" class="text-xs text-slate-400 hover:text-red-500 font-medium flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Delete
                            </button>
                            <button onclick="toggleMistakeResolved('${m.id}')" class="text-xs font-bold flex items-center gap-1 ${m.resolved ? 'text-green-600 dark:text-green-400' : 'text-slate-500 hover:text-brand-600'}">
                                <i data-lucide="${m.resolved ? 'check-circle-2' : 'circle'}" class="w-3 h-3"></i>
                                ${m.resolved ? 'Resolved' : 'Mark Resolved'}
                            </button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });

            if(window.lucide) lucide.createIcons({ root: list });
        };

        window.updateShelfCounts = function() {
            const counts = { Physics: 0, Chemistry: 0, Biology: 0 };
            (state.mistakes || []).forEach(m => {
                if(counts[m.subject] !== undefined && !m.resolved) counts[m.subject]++;
            });
            
            const pEl = document.getElementById('count-physics');
            const cEl = document.getElementById('count-chemistry');
            const bEl = document.getElementById('count-biology');

            if(pEl) pEl.textContent = `${counts.Physics} Active Errors`;
            if(cEl) cEl.textContent = `${counts.Chemistry} Active Errors`;
            if(bEl) bEl.textContent = `${counts.Biology} Active Errors`;
        };

        window.updateFooterProgress = function() { renderStats(); };
        window.toggleDailyTest = function(uniqueId) { state.expandedTests[uniqueId] = !state.expandedTests[uniqueId]; renderSyllabus(state.activeView === 'backlog' ? 'backlog' : 'main'); };
        window.toggleChapter = function(uniqueId) { state.expandedTests[uniqueId] = !state.expandedTests[uniqueId]; renderSyllabus(state.activeView === 'backlog' ? 'backlog' : 'main'); };
        window.addSyllabusTask = function(txt, type, subject, chapter) { addTask(`Study: ${txt}`, type, subject, chapter); };
        
        // FIXED: Immutable date operation
        window.changeDay = function(d) { 
            const newDate = new Date(state.selectedDate);
            newDate.setDate(newDate.getDate() + d);
            state.selectedDate = newDate;
            renderAll(); 
        };
        
        window.goToToday = function() {
            state.selectedDate = new Date();
            renderAll();
        };


// --- LEADERBOARD LOGIC ---
let leaderboardCache = [];
let activeRankTab = 'overall';

window.switchRankTab = function(tab) {
    activeRankTab = tab;
    ['overall', 'exam', 'backlog', 'tests'].forEach(t => {
        const btn = document.getElementById(`tab-${t}`);
        if(btn) {
            if(t === tab) btn.className = "px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400 ring-1 ring-black/5 dark:ring-white/10";
            else btn.className = "px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200";
        }
    });
    renderLeaderboardList();
};

window.fetchLeaderboard = async function() {
    if (!isFirebaseActive) {
        document.getElementById('leaderboard-list').innerHTML = `<div class="p-8 text-center text-slate-400">Leaderboard requires Cloud Sync. Please log in.</div>`;
        return;
    }
    try {
        // Fetch top 50 users
        const q = query(collection(db, "leaderboard"), orderBy("overallScore", "desc"), limit(50));
        const snapshot = await getDocs(q);
        leaderboardCache = [];
        snapshot.forEach(doc => {
            leaderboardCache.push({ id: doc.id, ...doc.data() });
        });
        renderLeaderboardList();
    } catch (e) {
        console.error("Error fetching leaderboard:", e);
        document.getElementById('leaderboard-list').innerHTML = `<div class="p-8 text-center text-red-400">Failed to load rankings.<br>Check Firestore rules.</div>`;
    }
};

window.renderLeaderboardList = function() {
    const list = document.getElementById('leaderboard-list');
    if(!list) return;

    const myStats = calculateUserStats();
    const myId = currentUser ? currentUser.uid : null;

    // Header Text
    const headerScore = document.getElementById('lb-header-score');
    if(headerScore) {
        if(activeRankTab === 'overall') headerScore.textContent = 'Study Score';
        else if(activeRankTab === 'exam') headerScore.textContent = 'Exam Progress';
        else if(activeRankTab === 'backlog') headerScore.textContent = 'Backlog Progress';
        else headerScore.textContent = 'Tests Taken';
    }

    // My Stats Card Update (WITH NAME SUPPORT)
    const myNameEl = document.getElementById('lb-user-name');
    if(myNameEl) myNameEl.textContent = state.displayName || (currentUser ? currentUser.email.split('@')[0] : "Guest");
    
    const myExamEl = document.getElementById('lb-my-exam');
    if(myExamEl) myExamEl.textContent = `${myStats.mainPct}%`;

    const myBacklogEl = document.getElementById('lb-my-backlog');
    if(myBacklogEl) myBacklogEl.textContent = `${myStats.blPct}%`;

    const myTestsEl = document.getElementById('lb-my-tests');
    if(myTestsEl) myTestsEl.textContent = myStats.testCount;

    // Sort Data based on selected tab
    let sortedData = [...leaderboardCache];
    if (activeRankTab === 'overall') sortedData.sort((a, b) => (b.overallScore || 0) - (a.overallScore || 0));
    else if (activeRankTab === 'exam') sortedData.sort((a, b) => (b.mainPct || 0) - (a.mainPct || 0));
    else if (activeRankTab === 'backlog') sortedData.sort((a, b) => (b.blPct || 0) - (a.blPct || 0));
    else if (activeRankTab === 'tests') sortedData.sort((a, b) => (b.testCount || 0) - (a.testCount || 0));

    // Calculate My Rank
    const myRankIndex = sortedData.findIndex(u => u.id === myId);
    const rankEl = document.getElementById('lb-my-rank');
    if(rankEl) rankEl.textContent = myRankIndex > -1 ? `#${myRankIndex + 1}` : '-';

    if(sortedData.length === 0) {
        list.innerHTML = `<div class="p-8 text-center text-slate-400">No data available yet. Start studying!</div>`;
        return;
    }

    list.innerHTML = sortedData.map((user, index) => {
        let scoreDisplay = '';
        if(activeRankTab === 'overall') scoreDisplay = `<span class="text-brand-600 dark:text-brand-400">${Math.round(user.overallScore || 0)} pts</span>`;
        else if(activeRankTab === 'exam') scoreDisplay = `${user.mainPct || 0}%`;
        else if(activeRankTab === 'backlog') scoreDisplay = `${user.blPct || 0}%`;
        else scoreDisplay = `${user.testCount || 0}`;

        const isMe = user.id === myId;
        const rankColor = index === 0 ? 'text-yellow-500' : (index === 1 ? 'text-slate-400' : (index === 2 ? 'text-orange-500' : 'text-slate-500'));
        const medal = index === 0 ? '<i data-lucide="crown" class="w-4 h-4 inline mb-1"></i>' : `#${index + 1}`;
        
        // CHECK FOR NAME FIRST, THEN EMAIL
        const userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Anonymous');
        const firstLetter = userName.charAt(0).toUpperCase();

        return `
            <div class="grid grid-cols-12 gap-4 p-4 items-center hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${isMe ? 'bg-brand-50/50 dark:bg-brand-900/10' : ''}">
                <div class="col-span-2 text-center font-black ${rankColor} text-sm">${medal}</div>
                <div class="col-span-6 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-600 dark:text-slate-300">
                        ${firstLetter}
                    </div>
                    <p class="text-sm font-bold text-slate-800 dark:text-slate-200 truncate">
                        ${userName.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")} ${isMe ? '(You)' : ''}
                    </p>
                </div>
                <div class="col-span-4 text-right font-bold text-slate-700 dark:text-white">${scoreDisplay}</div>
            </div>
        `;
    }).join('');

    if(window.lucide) lucide.createIcons({ root: list });
};
     
// --- PROFILE FUNCTIONS ---
    window.openProfileModal = function() {
        const input = document.getElementById('profile-name-input');
        if(state.displayName) input.value = state.displayName;
        document.getElementById('profile-modal').classList.remove('hidden');
        input.focus();
    };

    window.saveProfileName = function() {
        const input = document.getElementById('profile-name-input');
        const newName = input.value.trim();
        
        if(newName) {
            state.displayName = newName;
            if(isFirebaseActive && currentUser) {
                const docRef = getSafeDocRef(currentUser.uid);
                setDoc(docRef, { displayName: newName }, { merge: true });
            } else {
                localStorage.setItem('studyflow_username', newName);
            }
            saveData();
        }
        document.getElementById('profile-modal').classList.add('hidden');
        renderHeader(); 
    };

// --- NEW: SMART WEIGHTED LOAD BALANCER ---

let currentAiSuggestions = { main: [], backlog: [] };

window.checkStudyPace = function() {
    const container = document.getElementById('ai-strategy-container');
    if (!container) return;
    
    container.innerHTML = ''; 
    container.classList.remove('hidden');

    const today = new Date(); 
    today.setHours(0,0,0,0);

    // --- 1. DEFINE POINTS SYSTEM ---
    const getWeight = (subject, topic) => {
        if (subject === 'Physics') return 4;
        if (subject === 'Botany') return 1;
        if (subject === 'Zoology') return 1;
        
        if (subject === 'Chemistry') {
            const t = topic.toLowerCase();
            // Physical Chemistry (3 pts)
            if (t.includes('thermo') || t.includes('equilibrium') || t.includes('kinetics') || 
                t.includes('electro') || t.includes('solution') || t.includes('solid') || 
                t.includes('state') || t.includes('atom') || t.includes('mole')) return 3;
            
            // Organic Chemistry (3 pts)
            if (t.includes('organic') || t.includes('hydrocarbon') || t.includes('halo') || 
                t.includes('alcohol') || t.includes('aldehyde') || t.includes('amine') || 
                t.includes('bio') || t.includes('polymer')) return 3;

            // Inorganic Chemistry (2 pts) - Default for others like Bonding, Block chem
            return 2;
        }
        return 1; // Fallback
    };

    // --- 2. GENERATE MIX ---
    function generateSmartMix(trackName, syllabusData, deadlineDate, colorTheme) {
        if (!deadlineDate) return null;

        const dDate = new Date(deadlineDate);
        
        // FIXED: Calculate raw days and exclude exam day for Main Track only
        let rawDays = Math.ceil((dDate - today) / (1000 * 60 * 60 * 24));
        if (trackName === 'main') {
            rawDays = rawDays > 0 ? rawDays - 1 : 0;
        }
        const daysLeft = Math.max(1, rawDays);

        // Organize buckets by specific type
        const buckets = {
            'Physics': [],
            'Physical Chem': [],
            'Organic Chem': [],
            'Inorganic Chem': [],
            'Botany': [],
            'Zoology': []
        };
        
        let totalPoints = 0;
        let totalItems = 0;

        syllabusData.forEach(chapter => {
            chapter.dailyTests.forEach(dt => {
                if (!state.dailyTestsAttempted[dt.name]) {
                    const pts = getWeight(chapter.subject, chapter.topic);
                    
                    // Determine Bucket Key based on Points & Subject
                    let key = chapter.subject;
                    if (chapter.subject === 'Chemistry') {
                        // FIXED: Added 'halo', 'alcohol', 'aldehyde' etc. to ensure they go to Organic, not Physical
if (pts === 3 && (
    chapter.topic.toLowerCase().includes('organic') || 
    chapter.topic.toLowerCase().includes('hydro') || 
    chapter.topic.toLowerCase().includes('halo') || 
    chapter.topic.toLowerCase().includes('alcohol') ||
    chapter.topic.toLowerCase().includes('aldehyde') ||
    chapter.topic.toLowerCase().includes('amine')
)) key = 'Organic Chem';
                        else if (pts === 3) key = 'Physical Chem';
                        else key = 'Inorganic Chem';
                    }

                    const item = { 
                        name: dt.name, 
                        subject: chapter.subject, 
                        topic: chapter.topic,
                        points: pts 
                    };

                    if(buckets[key]) buckets[key].push(item);
                    else buckets['Physics'].push(item); // Fallback
                    
                    totalPoints += pts;
                    totalItems++;
                }
            });
        });

        if (totalItems === 0) return null;

        // Calculate Daily Target (Points per Day)
        // FIXED: Added 5% "Panic Buffer" (Tighter Schedule)
        const dailyTarget = Math.ceil((totalPoints / daysLeft) * 1.05);
        // Round Robin Selection Logic
        // Order: Phy -> Phys Chem -> Org Chem -> Inorg Chem -> Bot -> Zoo
        const rotation = ['Physics', 'Physical Chem', 'Organic Chem', 'Inorganic Chem', 'Botany', 'Zoology'];
        
        let selectedBatch = [];
        let currentPoints = 0;
        let safety = 0;
        
        while(currentPoints < dailyTarget && safety < totalItems) {
            let added = false;
            for (const type of rotation) {
                if (currentPoints >= dailyTarget) break;
                
                if (buckets[type] && buckets[type].length > 0) {
                    const task = buckets[type].shift(); // Take 1
                    selectedBatch.push(task);
                    currentPoints += task.points;
                    added = true;
                    safety++;
                }
            }
            if (!added) break;
        }

        currentAiSuggestions[trackName] = selectedBatch;

        // Check if Planned
        const k = formatDateKey(state.selectedDate);
        const currentTasks = state.tasks[k] || [];
        const isPlanned = selectedBatch.every(s => currentTasks.some(t => t.text.includes(s.name)));

        if (isPlanned) return null;

        return {
            name: trackName === 'main' ? 'Exam Smart Mix' : 'Backlog Strategy',
            days: daysLeft,
            dailyCount: selectedBatch.length,
            points: currentPoints,
            color: colorTheme,
            trackId: trackName,
            // Generate Preview Text (e.g., "Phy: 1, Org: 1")
            preview: selectedBatch.reduce((acc, item) => {
                let n = item.subject;
                if(n === 'Physics') n = 'Phy';
                if(n === 'Botany') n = 'Bot';
                if(n === 'Zoology') n = 'Zoo';
                if(n === 'Chemistry') {
// FIXED CODE: Matches the bucket logic
if(item.points === 3 && (
    item.topic.toLowerCase().includes('organic') || 
    item.topic.toLowerCase().includes('hydro') || 
    item.topic.toLowerCase().includes('halo') ||
    item.topic.toLowerCase().includes('alcohol') ||
    item.topic.toLowerCase().includes('aldehyde') ||
    item.topic.toLowerCase().includes('amine')
)) n = 'Org';
else if(item.points === 3) n = 'Phys';                    
                    else n = 'Inorg';
                }
                acc[n] = (acc[n] || 0) + 1;
                return acc;
            }, {})
        };
    }

    const mainStats = generateSmartMix('main', state.nextExam.syllabus, state.nextExam.date, 'violet');
    const backlogStats = generateSmartMix('backlog', backlogPlan.syllabus, backlogPlan.date, 'orange');

    let html = '';

    const renderCard = (stats) => {
        const isV = stats.color === 'violet';
        const bg = isV ? 'bg-violet-50 dark:bg-violet-900/10' : 'bg-orange-50 dark:bg-orange-900/10';
        const border = isV ? 'border-violet-200 dark:border-violet-800' : 'border-orange-200 dark:border-orange-800';
        const textMain = isV ? 'text-violet-700 dark:text-violet-300' : 'text-orange-700 dark:text-orange-300';
        const btnBg = isV ? 'bg-violet-600 hover:bg-violet-700' : 'bg-orange-600 hover:bg-orange-700';

        const mixText = Object.entries(stats.preview).map(([k,v]) => `${k}: ${v}`).join(', ');

        return `
        <div class="${bg} border ${border} rounded-2xl p-5 relative overflow-hidden group shadow-sm mb-4 animate-in slide-in-from-top-2 duration-500">
            <div class="absolute -right-6 -top-6 ${textMain} opacity-10 transform rotate-12"><i data-lucide="brain-circuit" class="w-32 h-32"></i></div>
            <div class="relative z-10 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${isV ? 'bg-violet-100 dark:bg-violet-900' : 'bg-orange-100 dark:bg-orange-900'} ${textMain} tracking-wide flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> ${stats.name}</span>
                        <span class="text-xs font-bold text-slate-400">${stats.days} Days Left</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Today's Load: <span class="${textMain}">${stats.points} Points</span> (${stats.dailyCount} Tests)</h3>
                    <div class="flex items-center gap-2 mt-2 text-xs text-slate-500 dark:text-slate-400 font-medium bg-white/50 dark:bg-black/20 px-3 py-1.5 rounded-lg border border-${stats.color}-100 dark:border-${stats.color}-900/30 w-fit">
                        <i data-lucide="layers" class="w-3 h-3"></i><span>Mix: ${mixText}</span>
                    </div>
                </div>
                <button onclick="acceptAiPlan('${stats.trackId}')" class="w-full md:w-auto px-6 py-3 ${btnBg} text-white rounded-xl text-sm font-bold shadow-lg shadow-${stats.color}-500/20 transition-all active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Smart Mix
                </button>
            </div>
        </div>`;
    };

    if (mainStats) html += renderCard(mainStats);
    if (backlogStats) html += renderCard(backlogStats);

    container.innerHTML = html;
    if (window.lucide) lucide.createIcons({ root: container });
};


window.acceptAiPlan = function(track) {
    const suggestions = currentAiSuggestions[track];
    if (!suggestions || suggestions.length === 0) return;

    let addedCount = 0;
    const key = formatDateKey(state.selectedDate);

    suggestions.forEach(item => {
        // Find the full test data from the syllabus to get all sub-topics
        const sourceData = track === 'main' ? state.nextExam.syllabus : backlogPlan.syllabus;
        const chapter = sourceData.find(c => c.topic === item.topic);
        const testData = chapter?.dailyTests.find(dt => dt.name === item.name);

        if (testData) {
            testData.subs.forEach(sub => {
                const taskText = `Study: ${item.topic} - ${sub}`;
                // Only add if the task isn't already on today's list
                const exists = (state.tasks[key] || []).some(t => t.text === taskText);
                
                if (!exists) {
                    addTask(taskText, track, item.subject, item.topic);
                    addedCount++;
                }
            });
        }
    });

    // Save and Refresh
    saveData();
    renderAll();

    // Feedback
    if (window.confetti) {
        confetti({ 
            particleCount: 100, 
            spread: 50, 
            origin: { y: 0.8 },
            colors: track === 'main' ? ['#8b5cf6'] : ['#f97316']
        });
    }

    showToast(` Added ${addedCount} sub-topics to your mission. Complete them to unlock the Daily Tests!`);
};
 document.addEventListener('DOMContentLoaded', init);

        // Optimization: FOUC listener - Triggered on DOMContentLoaded instead of Load for faster paint
        document.addEventListener('DOMContentLoaded', () => {
            // Small timeout to allow Tailwind CDN to parse initial classes
            setTimeout(() => document.body.classList.add('loaded'), 50);
        });

        // UTILITY: Debounce for search performance
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Global search handler with debounce
        const debouncedRender = debounce((query, type) => {
            renderSyllabus(type, query);
        }, 300); // 300ms delay

        window.handleSearch = function(query, type) {
            debouncedRender(query, type);
        };

        
function renderAll() {
            renderHeader();
            updateHeaderPrayerBtn();
            renderStats();
            
            // Performance Optimization: Lazy Rendering
            if (state.activeView === 'overview') {
                renderTasks();
                checkStudyPace(); // This activates the Smart Coach
            } else if (state.activeView === 'target') {
                renderSyllabus('main');
            } else if (state.activeView === 'backlog') {
                renderSyllabus('backlog');
            } else if (state.activeView === 'mistakes') {
                if(state.activeNotebook) {
                    renderNotebookEntries();
                } else {
                    updateShelfCounts();
                }
            } else if (state.activeView === 'namaz') {
                renderNamazView();
            } else if (state.activeView === 'leaderboard') {
                renderLeaderboardList();
            }
            
            // Re-scan icons if library is loaded
            if(window.lucide) lucide.createIcons();
        }
// FIX: Make all these functions global so HTML buttons can see them
window.renderAll = renderAll;
window.renderTasks = renderTasks;
window.renderSyllabus = renderSyllabus;
        function renderHeader() {
            const els = { date: document.getElementById('overview-date'), agendaDate: document.getElementById('agenda-date-display') };
            const dateStr = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            if(els.date) els.date.textContent = state.selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            if(els.agendaDate) els.agendaDate.textContent = dateStr;
        }
function renderStats() {
            const today = new Date(); today.setHours(0,0,0,0);
            const exDate = new Date(state.nextExam.date); exDate.setHours(0,0,0,0);
            
            // FIXED: Exclude exam day from prep days for visual count
            let rawDiff = Math.ceil((exDate - today)/(1000*60*60*24));
            const diff = rawDiff > 0 ? rawDiff - 1 : rawDiff;
                    const formattedDate = state.nextExam.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Text Updates
            const elements = {
                name: document.getElementById('card-main-name'),
                date: document.getElementById('card-main-date-info'),
                days: document.getElementById('card-main-days'),
                sylTitle: document.getElementById('syllabus-title'),
                sylDate: document.getElementById('syllabus-date'),
                sylDays: document.getElementById('syllabus-days-left'),
                blDays: document.getElementById('backlog-days-left'),
                blLarge: document.getElementById('backlog-days-large')
            };

            if(elements.name) elements.name.textContent = state.nextExam.name;
            if(elements.date) elements.date.textContent = `Exam Date: ${formattedDate}`;
            if(elements.days) elements.days.textContent = diff; // Allow negatives to show passed
            if(elements.sylTitle) elements.sylTitle.textContent = state.nextExam.name + " Syllabus";
            if(elements.sylDate) elements.sylDate.textContent = formattedDate;
            if(elements.sylDays) elements.sylDays.textContent = `${diff} Days Left`;

            const blDate = new Date(backlogPlan.date); blDate.setHours(0,0,0,0);
            const blDiff = Math.ceil((blDate - today)/(1000*60*60*24));
            if(elements.blDays) elements.blDays.textContent = `${blDiff} Days Left`;
            if(elements.blLarge) elements.blLarge.textContent = blDiff;

            // Global Progress Calculation
            const allCompleted = new Set(Object.values(state.tasks).flat().filter(t => t.completed).map(t => t.text));
            
            // Main Syllabus Progress
            let mainTotal = 0, mainDone = 0;
            state.nextExam.syllabus.forEach(s => s.dailyTests.forEach(dt => dt.subs.forEach(sub => {
                mainTotal++;
                if(allCompleted.has(`Study: ${s.topic} - ${sub}`)) mainDone++;
            })));
            const mainPct = mainTotal ? Math.round((mainDone/mainTotal)*100) : 0;
            const mainBar = document.getElementById('card-main-bar');
            if(mainBar) mainBar.style.width = `${mainPct}%`;
            const mainText = document.getElementById('card-main-text');
            if(mainText) mainText.textContent = `${mainPct}%`;

            // Backlog Progress
            let blTotal = 0, blDone = 0;
            backlogPlan.syllabus.forEach(s => s.dailyTests.forEach(dt => dt.subs.forEach(sub => {
                blTotal++;
                if(allCompleted.has(`Study: ${s.topic} - ${sub}`)) blDone++;
            })));
            const blPct = blTotal ? Math.round((blDone/blTotal)*100) : 0;
            const blBar = document.getElementById('card-backlog-bar');
            if(blBar) blBar.style.width = `${blPct}%`;
            const blText = document.getElementById('card-backlog-text');
            if(blText) blText.textContent = `${blPct}%`;

            // Sidebar / Daily Goal Logic
            const subjectSelect = document.getElementById('new-task-subject');
            const selectedSubject = subjectSelect ? subjectSelect.value : 'General';
            const k = formatDateKey(state.selectedDate);
            const todays = state.tasks[k] || [];
            
            let filteredTasks = todays;
            if (selectedSubject !== 'General') filteredTasks = todays.filter(t => t.subject === selectedSubject);

            const totalFiltered = filteredTasks.length;
            const completedFiltered = filteredTasks.filter(t=>t.completed).length;
            const dayPct = totalFiltered ? Math.round((completedFiltered / totalFiltered)*100) : 0;
            
            // CONFETTI & SOUND LOGIC
            if (totalFiltered > 0 && dayPct === 100 && !state.goalCompletedToday) {
                // Check if this completion just happened (avoid looping on re-render)
                state.goalCompletedToday = true; 
                try {
                    // Realistic Confetti Fire
                    var count = 200;
                    var defaults = { origin: { y: 0.7 } };

                    function fire(particleRatio, opts) {
                        if (window.confetti) {
                            confetti(Object.assign({}, defaults, opts, {
                                particleCount: Math.floor(count * particleRatio)
                            }));
                        }
                    }

                    fire(0.25, { spread: 26, startVelocity: 55, });
                    fire(0.2, { spread: 60, });
                    fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                    fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                    fire(0.1, { spread: 120, startVelocity: 45, });
                    
                    // Sound
                    successSound.currentTime = 0;
                    successSound.play().catch(e => console.log("Audio play failed (interaction required first)"));
                } catch(e) {
                    console.log("Effects failed", e);
                }
            } else if (dayPct < 100) {
                state.goalCompletedToday = false;
            }

            // Gradient Bar
            let completedExamCount = filteredTasks.filter(t => t.completed && t.type === 'main').length;
            let completedBacklogCount = filteredTasks.filter(t => t.completed && t.type === 'backlog').length;
            let gradientStyle = `bg-brand-500`; 
            
            if (completedFiltered > 0) {
                const totalScored = completedExamCount + completedBacklogCount;
                if (totalScored > 0) {
                    const examShare = (completedExamCount / totalScored) * 100;
                    gradientStyle = `background: linear-gradient(90deg, #0ea5e9 0%, #0ea5e9 ${examShare}%, #f97316 ${examShare}%, #f97316 100%)`;
                } else { gradientStyle = `background-color: #0ea5e9`; }
            } else { gradientStyle = `background-color: #0ea5e9`; }

            const sideBar = document.getElementById('sidebar-progress-bar');
            if(sideBar) {
                sideBar.style = `width: ${dayPct}%; ${gradientStyle}`;
                sideBar.classList.remove('bg-brand-500'); 
            }
            
            const sideText = document.getElementById('sidebar-progress-text');
            if(sideText) sideText.textContent = `${dayPct}%`;
// --- START OF NEW CODE FOR MOBILE ---
            const mobSideBar = document.getElementById('mobile-sidebar-progress-bar');
            if(mobSideBar) {
                mobSideBar.style = `width: ${dayPct}%; ${gradientStyle}`;
                mobSideBar.classList.remove('bg-brand-500'); 
            }
            
            const mobSideText = document.getElementById('mobile-sidebar-progress-text');
            if(mobSideText) mobSideText.textContent = `${dayPct}%`;
            // --- END OF NEW CODE FOR MOBILE ---
            
            const footerLabel = document.getElementById('footer-goal-label');
            if(footerLabel) footerLabel.textContent = selectedSubject === 'General' ? 'Daily Goal' : `${selectedSubject} Goal`;
        }

 function createTaskElementHTML(t, isSubTask = false) {
            // Updated Styles for "Pill" look
            let wrapperClass = "group flex items-center justify-between p-3 rounded-2xl transition-all duration-200 border relative overflow-hidden ";
            
            if (t.type === 'main') {
                wrapperClass += "bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 hover:border-brand-300 dark:hover:border-brand-700 hover:shadow-md dark:hover:shadow-none hover:shadow-brand-500/5";
            } else if (t.type === 'backlog') {
                wrapperClass += "bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 hover:border-orange-300 dark:hover:border-orange-700 hover:shadow-md hover:shadow-orange-500/5";
            } else {
                wrapperClass += "bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-600 hover:shadow-sm";
            }

            // Subtasks (inside groups) get a slightly different look
            if(isSubTask) {
                wrapperClass = "flex items-center justify-between p-2.5 pl-4 rounded-xl border border-transparent hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all mb-1";
            }

            // Completed State
            if (t.completed) {
                wrapperClass += " opacity-60 grayscale";
            }

            // Tags
            let typeColorClass = t.type === 'main' 
                ? 'text-brand-600 bg-brand-50 dark:bg-brand-900/20 dark:text-brand-300' 
                : (t.type === 'backlog' ? 'text-orange-600 bg-orange-50 dark:bg-orange-900/20 dark:text-orange-300' : 'text-slate-500 bg-slate-100 dark:bg-slate-800');
            
            let subjectColor = getSubjectColor(t.subject).replace('bg-', 'bg-opacity-50 bg-'); // Make lighter

            let displayText = t.text;
            if(isSubTask && t.chapter) {
                 const prefix = `Study: ${t.chapter} - `;
                 if(displayText.startsWith(prefix)) displayText = displayText.substring(prefix.length);
            }

            // Safe HTML escape to match your security standards
            const safeText = escapeHtml(displayText);

            return `
                <div class="${wrapperClass}">
                    ${t.completed ? '<div class="absolute inset-0 bg-slate-100/50 dark:bg-black/50 z-0 pointer-events-none"></div>' : ''}
                    
                    <div class="flex items-center gap-4 overflow-hidden cursor-pointer flex-1 relative z-10" onclick="toggleTask('${t.id}')">
                        <div class="w-6 h-6 rounded-full border-2 flex-shrink-0 flex items-center justify-center transition-all duration-300 ${t.completed ? 'bg-green-500 border-green-500 scale-110' : 'border-slate-300 dark:border-slate-600 hover:border-brand-400'}">
                            <i data-lucide="check" class="w-3.5 h-3.5 text-white transform ${t.completed ? 'scale-100' : 'scale-0'} transition-transform duration-200"></i>
                        </div>
                        
                        <div class="flex flex-col min-w-0">
                            <span class="truncate text-sm font-semibold ${t.completed ? 'text-slate-400 line-through decoration-2 decoration-slate-300' : 'text-slate-800 dark:text-slate-200'}">${safeText}</span>
                            
                            ${!isSubTask ? `
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${subjectColor}">${t.subject}</span>
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${typeColorClass}">${t.type === 'main' ? 'Exam Prep' : (t.type === 'backlog' ? 'Backlog' : 'Task')}</span>
                            </div>` : ''}
                        </div>
                    </div>
                    
                    <button onclick="deleteTask('${t.id}')" class="relative z-10 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-lg transition-all" aria-label="Delete Task">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }       

function renderTasks() {
            const list = document.getElementById('overview-task-list');
            if(!list) return;
            const k = formatDateKey(state.selectedDate);
            const tasks = state.tasks[k] || [];
            
            list.innerHTML = '';

            // --- IMPROVED LOGIC: DETECT "READY" TESTS ONLY ---
            
            // 1. Snapshot of all completed tasks
            const allCompleted = new Set(Object.values(state.tasks).flat().filter(t => t.completed).map(t => t.text));
            const readyTests = [];

            // 2. Scan Syllabus
            function scanSyllabus(syllabusArray, source) {
                if(!syllabusArray) return;
                
                syllabusArray.forEach(chapter => {
                    chapter.dailyTests.forEach(test => {
                        // Skip if already done
                        if(state.dailyTestsAttempted[test.name]) return;

                        // Check subtopics
                        const missingSubs = [];
                        test.subs.forEach(sub => {
                            const expectedTaskName = `Study: ${chapter.topic} - ${sub}`;
                            if(!allCompleted.has(expectedTaskName)) {
                                missingSubs.push(sub);
                            }
                        });

                        const total = test.subs.length;
                        const missingCount = missingSubs.length;

                        // Case A: Fully Ready (All topics done)
                        if(missingCount === 0 && total > 0) {
                            readyTests.push({
                                name: test.name,
                                topic: chapter.topic,
                                subject: chapter.subject,
                                subs: test.subs,
                                source: source
                            });
                        }
                    });
                });
            }

            // 3. Run Scan
            if(state.nextExam) scanSyllabus(state.nextExam.syllabus, 'main');
            if(typeof backlogPlan !== 'undefined') scanSyllabus(backlogPlan.syllabus, 'backlog');

            // 4. Render "READY" Cards (Green)
            if(readyTests.length > 0) {
                const readyHtml = readyTests.map(test => {
                    const subSummary = test.subs.slice(0, 3).join(', ') + (test.subs.length > 3 ? '...' : '');
                    
                    return `
                    <div class="mb-6 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-5 text-white shadow-lg shadow-emerald-500/20 relative overflow-hidden group animate-in slide-in-from-top-2 fade-in duration-300">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="award" class="w-24 h-24 rotate-12"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <span class="bg-white/20 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-white border border-white/10">
                                        Unlocked
                                    </span>
                                    <h3 class="text-xl font-bold text-white tracking-tight mt-1">${test.name}</h3>
                                    <p class="text-xs text-emerald-100 font-medium">Topic: ${test.topic}</p>
                                </div>
                                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm shadow-sm animate-pulse">
                                    <i data-lucide="unlock" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                            
                            <div class="bg-black/10 rounded-lg p-2 mb-4">
                                <p class="text-[10px] uppercase font-bold text-emerald-200 mb-1">Includes</p>
                                <p class="text-xs text-white/90 font-medium truncate">${subSummary}</p>
                            </div>

                            <button onclick="confetti({particleCount: 150, spread: 60, origin: { y: 0.7 }}); toggleTestAttempt('${test.name}'); renderAll();" 
                                class="w-full bg-white text-emerald-700 py-3 rounded-xl text-sm font-bold shadow-md hover:bg-emerald-50 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                                <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                                Attempt & Mark Done
                            </button>
                        </div>
                    </div>
                `}).join('');
                list.insertAdjacentHTML('beforeend', readyHtml);
            }
            // --- END NEW LOGIC ---

            // --- STANDARD TASK RENDERING ---
            if(tasks.length === 0 && readyTests.length === 0) {
                list.innerHTML = `<div class="h-40 flex flex-col items-center justify-center text-slate-400 dark:text-slate-600 text-sm"><i data-lucide="coffee" class="w-8 h-8 mb-2 opacity-50"></i>No focus targets set.</div>`;
                if(window.lucide) lucide.createIcons({ root: list });
                return;
            }

            const groups = {};
            const standalone = [];
            tasks.forEach(t => {
                let chap = t.chapter;
                if (!chap && t.text.startsWith("Study: ")) {
                    const parts = t.text.replace("Study: ", "").split(" - ");
                    if (parts.length > 1) chap = parts[0];
                }
                if (chap) {
                    if (!groups[chap]) groups[chap] = { name: chap, tasks: [], subject: t.subject, type: t.type };
                    groups[chap].tasks.push(t);
                } else standalone.push(t);
            });

            standalone.forEach(t => {
                const el = document.createElement('div');
                el.innerHTML = createTaskElementHTML(t, false);
                list.appendChild(el.firstElementChild);
            });

            Object.values(groups).forEach(group => {
                const isExpanded = state.expandedFocusGroups[group.name];
                const completedCount = group.tasks.filter(t => t.completed).length;
                const totalCount = group.tasks.length;
                const isAllDone = totalCount > 0 && completedCount === totalCount;
                
                let groupBorder = 'border-slate-200 dark:border-slate-800';
                let groupBg = 'bg-white dark:bg-slate-900';
                if(group.type === 'main') { groupBorder = 'border-brand-200 dark:border-brand-900'; groupBg = 'bg-brand-50/30 dark:bg-brand-900/10'; }
                if(group.type === 'backlog') { groupBorder = 'border-orange-200 dark:border-orange-900'; groupBg = 'bg-orange-50/30 dark:bg-orange-900/10'; }
                
                let typeBadge = '';
                if (group.type === 'main') typeBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-brand-100 dark:bg-brand-900 text-brand-700 dark:text-brand-300">Exam</span>`;
                else if (group.type === 'backlog') typeBadge = `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300">Backlog</span>`;
                
                const safeGroupName = group.name.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                const escapeQuote = (str) => str.replace(/'/g, "\\'");

                const groupContainer = document.createElement('div');
                groupContainer.className = `rounded-xl border ${groupBorder} ${groupBg} overflow-hidden mb-2 transition-all shadow-sm group`;
                
                const headerHtml = `
                    <div class="p-3 flex items-center justify-between cursor-pointer hover:bg-opacity-50 transition-colors" onclick="toggleFocusGroup('${escapeQuote(group.name)}')">
                        <div class="flex items-center gap-3">
                            <div class="p-1.5 rounded-lg ${isAllDone ? 'bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300' : 'bg-white dark:bg-slate-800 shadow-sm text-slate-500 dark:text-slate-400'}">
                                <i data-lucide="${isAllDone ? 'check-circle' : 'book-open'}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-slate-800 dark:text-slate-200 leading-tight">${safeGroupName}</h4>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[9px] uppercase font-bold tracking-wider text-slate-500 dark:text-slate-400">${group.subject}</span>
                                    ${typeBadge}
                                    <span class="text-[9px] font-medium text-slate-400"></span>
                                    <span class="text-[9px] font-medium ${isAllDone ? 'text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-slate-400'}">${completedCount}/${totalCount} Done</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="deleteGroup('${escapeQuote(group.name)}'); event.stopPropagation();" class="text-slate-300 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100" title="Delete Chapter">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"></i>
                        </div>
                    </div>
                `;
                
                let bodyHtml = '';
                if (isExpanded) {
                    const taskListHtml = group.tasks.map(t => createTaskElementHTML(t, true)).join('');
                    bodyHtml = `
                        <div class="border-t ${groupBorder} p-2 pl-4 bg-white/50 dark:bg-slate-900/50 animate-in fade-in slide-in-from-top-1 duration-200">
                            ${taskListHtml}
                        </div>
                    `;
                }
                groupContainer.innerHTML = headerHtml + bodyHtml;
                list.appendChild(groupContainer);
            });
            
            if(window.lucide) lucide.createIcons({ root: list });
        }



          // Optimized Render Syllabus with Search & Fragments
        function renderSyllabus(type, searchQuery = '') {
            const container = document.getElementById(type === 'main' ? 'main-syllabus-container' : 'backlog-syllabus-container');
            if(!container) return;
            
            // 1. Clear Container
            container.innerHTML = '';

            // 2. Prepare Data & Helpers
            const rawData = type === 'main' ? state.nextExam.syllabus : backlogPlan.syllabus;
            const allTasks = new Set(Object.values(state.tasks).flat().map(t => t.text)); 
            const allCompleted = new Set(Object.values(state.tasks).flat().filter(t => t.completed).map(t => t.text));
            const lowerQuery = searchQuery.toLowerCase().trim();

            // 3. Performance: Create a DocumentFragment (Batch DOM insertions)
            const fragment = document.createDocumentFragment();
            let hasResults = false;

            // FIXED: Safe Regex creation to prevent crashes
            const safeQuery = escapeRegex(lowerQuery);
            const queryRegex = safeQuery ? new RegExp(`(${safeQuery})`, 'gi') : null;

            rawData.forEach((item, chapterIdx) => {
                // --- SEARCH LOGIC ---
                // Check if chapter matches
                const chapterMatch = item.topic.toLowerCase().includes(lowerQuery) || item.subject.toLowerCase().includes(lowerQuery);
                
                // Check if any sub-tests match
                const matchingTests = item.dailyTests.filter(dt => {
                    if (chapterMatch) return true; // Keep all if chapter matches
                    return dt.name.toLowerCase().includes(lowerQuery) || 
                        dt.subs.some(sub => sub.toLowerCase().includes(lowerQuery));
                });

                // If searching and no matches, skip this card completely
                if (lowerQuery && !chapterMatch && matchingTests.length === 0) return;
                
                hasResults = true;
                // --------------------

                const chapterId = `${type}-chapter-${chapterIdx}`;
                // Auto-expand if user is searching, otherwise use saved state
                const isChapterExpanded = lowerQuery ? true : state.expandedTests[chapterId];
                
                const allDailyTests = item.dailyTests || [];
                const allDailyTestsCompleted = allDailyTests.every(dt => state.dailyTestsAttempted[dt.name]);
                
                // Styles
                const chapterCardClass = allDailyTestsCompleted 
                    ? "bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-900 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow card-transition mb-4"
                    : "bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow card-transition mb-4";
                
                const chapterHeaderClass = allDailyTestsCompleted
                    ? "bg-green-100 dark:bg-green-900/20 px-4 py-3 border-b border-green-200 dark:border-green-800 flex justify-between items-center cursor-pointer select-none"
                    : "bg-slate-50 dark:bg-slate-800 px-4 py-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center cursor-pointer select-none";

                // Create Card DOM
                const card = document.createElement('div');
                card.className = chapterCardClass;
                
                // FIXED: Sanitization + Safe Highlighting
                const safeTopic = escapeHtml(item.topic);
                const displayTopic = queryRegex 
                    ? safeTopic.replace(queryRegex, '<span class="bg-yellow-200 dark:bg-yellow-900/50 text-slate-900 dark:text-white">$1</span>')
                    : safeTopic;

                let html = `
                    <div class="${chapterHeaderClass}" onclick="toggleChapter('${chapterId}')">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-wider ${allDailyTestsCompleted ? 'text-green-700 dark:text-green-300' : 'text-slate-400 dark:text-slate-500'}">${item.subject}</span>
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold text-slate-800 dark:text-white">${displayTopic}</h4> 
                                ${allDailyTestsCompleted ? '<i data-lucide="check-circle" class="w-4 h-4 text-green-600 dark:text-green-400"></i>' : ''}
                            </div>
                        </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300 ${isChapterExpanded ? 'rotate-180' : ''}"></i>
                    </div>
                `;

                if (isChapterExpanded) {
                    html += `<div class="p-4 grid grid-cols-1 gap-3 animate-in fade-in slide-in-from-top-2 duration-300">`;
                    
                    // Only render tests that matched the search (or all if chapter matched)
                    const testsToRender = lowerQuery ? matchingTests : item.dailyTests;

                    testsToRender.forEach((dt, testIdx) => {
                        // Determine original index to keep ID consistent
                        const originalIndex = item.dailyTests.indexOf(dt);
                        const testId = `${chapterId}-test-${originalIndex}`;
                        
                        // Auto-expand tests if searching
                        const isTestExpanded = lowerQuery ? true : state.expandedTests[testId];
                        
                        const total = dt.subs.length;
                        const doneCount = dt.subs.filter(s => allCompleted.has(`Study: ${item.topic} - ${s}`)).length;
                        const isReady = total > 0 && doneCount === total;
                        const isAttempted = state.dailyTestsAttempted[dt.name];

                        let cardStyle = "border border-slate-100 dark:border-slate-800 rounded-lg bg-white dark:bg-slate-800 hover:border-brand-100 dark:hover:border-brand-900 transition-colors relative";
                        let cardContentStyle = ""; 
                        
                        if (isAttempted) {
                            cardStyle = "border-0 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 transition-colors relative shadow-md text-white";
                            cardContentStyle = "text-white"; 
                        }

                        const showCheckbox = isReady || isAttempted;
                        
                        // FIXED: Safe Highlight for Test Name
                        const safeTestName = escapeHtml(dt.name);
                        const displayName = queryRegex 
                            ? safeTestName.replace(queryRegex, '<span class="bg-yellow-200 dark:bg-yellow-600 text-black">$1</span>') 
                            : safeTestName;

                        html += `
                            <div class="${cardStyle} overflow-hidden">
                                <div class="p-3 flex justify-between items-center cursor-pointer" onclick="toggleDailyTest('${testId}')">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="chevron-right" class="w-4 h-4 ${isAttempted ? 'text-white/70' : 'text-slate-400 dark:text-slate-500'} transition-transform duration-200 ${isTestExpanded ? 'rotate-90' : ''}"></i>
                                        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                                                ${showCheckbox ? 
                                                `<input type="checkbox" 
                                                    ${isAttempted ? 'checked' : ''} 
                                                    onchange="toggleTestAttempt('${dt.name}')"
                                                    class="w-4 h-4 rounded border-slate-300 text-green-600 focus:ring-green-500 cursor-pointer"
                                                >` : ''
                                            }
                                            <span class="text-xs font-bold ${isAttempted ? 'text-green-800 bg-white/90' : 'text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700'} px-2 py-0.5 rounded backdrop-blur-sm select-text cursor-text">${displayName}</span>
                                        </div>
                                    </div>
                                        ${isAttempted ? 
                                        `<span class="text-[10px] font-bold text-green-700 bg-white px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm"><i data-lucide="award" class="w-3 h-3"></i> Done</span>` 
                                    : isReady ? 
                                        `<span class="text-[10px] font-bold text-green-600 dark:text-green-300 bg-green-50 dark:bg-green-900/30 px-2 py-0.5 rounded-full flex items-center gap-1 animate-pulse"><i data-lucide="check-circle" class="w-3 h-3"></i> Ready</span>` 
                                    :
                                        `<span class="text-[10px] font-medium ${isAttempted ? 'text-white/80' : 'text-slate-400 dark:text-slate-500'}">${doneCount}/${total}</span>`
                                    }
                                </div>
                                ${isTestExpanded ? `
                                    <div class="px-3 pb-3 pt-0 border-t ${isAttempted ? 'border-white/20' : 'border-slate-50 dark:border-slate-700'} animate-in fade-in slide-in-from-top-1 duration-200">
                                        <div class="space-y-1 mt-2 ${cardContentStyle}">
                                            ${dt.subs.map(sub => {
                                                const taskName = `Study: ${item.topic} - ${sub}`;
                                                const isAdded = allTasks.has(taskName);
                                                const isDone = allCompleted.has(taskName);
                                                
                                                // FIXED: Safe Highlight for Subtasks
                                                const safeSub = escapeHtml(sub);
                                                const displaySub = queryRegex 
                                                    ? safeSub.replace(queryRegex, '<span class="bg-yellow-200 dark:bg-yellow-600 text-black">$1</span>') 
                                                    : safeSub;

                                                let textClass = "text-slate-500 dark:text-slate-400";
                                                if (isAttempted) textClass = "text-white/90";
                                                if (isDone) textClass = isAttempted ? "line-through opacity-70 text-white/70" : "line-through opacity-50 decoration-slate-400 dark:decoration-slate-500";
                                                
                                                let btnClass = "text-brand-400 hover:text-brand-600 dark:hover:text-brand-300";
                                                if (isAttempted) btnClass = "text-white/80 hover:text-white";
                                                
                                                // FIXED: Updated tooltip to 'Add to Selected Date'
                                                return `
                                                    <div class="flex items-center justify-between group pl-6 py-0.5">
                                                        <span class="text-[11px] truncate w-3/4 ${textClass}" title="${safeSub}"> ${displaySub}</span>
                                                        ${!isDone ? 
                                                            `<button onclick="addSyllabusTask('${escape(item.topic)} - ${escape(sub)}', '${type}', '${item.subject}', '${escape(item.topic)}')" class="${btnClass} transition-colors p-1" title="${isAdded ? 'Already in Agenda' : 'Add to Selected Date'}" aria-label="Add to plan">
                                                                <i data-lucide="${isAdded ? 'copy-check' : 'plus-circle'}" class="w-4 h-4"></i>
                                                            </button>` : 
                                                            `<i data-lucide="check" class="w-3 h-3 ${isAttempted ? 'text-white' : 'text-green-500 dark:text-green-400'}"></i>`
                                                        }
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }

                card.innerHTML = html;
                fragment.appendChild(card);
            });

            if (!hasResults && lowerQuery) {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500">No topics found matching "${escapeHtml(searchQuery)}"</div>`;
            } else {
                container.appendChild(fragment); // Single reflow here
            }
            
            // Optimization: Only scan this container for icons
            if(window.lucide) lucide.createIcons({ root: container });
        }
    </script>
</body>
</html>